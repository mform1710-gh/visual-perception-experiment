<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹œì§€ê° ì‹¤í—˜ (ì˜¨ë¼ì¸)</title>

  <!-- ì„ íƒ CSS: ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìë™ ë¬´ì‹œ -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" crossorigin="anonymous" onerror="this.remove()" />

  <style>
    :root { color-scheme: dark; }
    html,body{ height:100%; }
    body { background:#000; color:#fff; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji; }
    .center-wrap { display:flex; align-items:center; justify-content:center; height:100vh; }
    .fixation { font-size:64px; line-height:1; font-weight:300; }
    .btn { padding:.6rem 1rem; border:1px solid #666; border-radius:.6rem; background:#111; color:#fff; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .btn:hover { background:#1d1d1d; }
    .small { font-size:.9rem; color:#aaa; }
    .container { max-width:1000px; margin:0 auto; padding:2rem; }
    .fullscreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .stim-img { max-width:90vw; max-height:70vh; object-fit:contain; display:block; }
    .hint { color:#9ad0ff; }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.75rem; }
    .row { display:flex; gap:1rem; align-items:flex-start; }
    .board { position:relative; display:inline-block; }
    .shape { position:absolute; box-sizing:border-box; }
    .shape.window { background:#6cf; opacity:.9; }
    .shape.door { border:4px solid #ff9; border-radius:50%; background:rgba(255,255,0,0.1); }
    .shape.selected { outline:2px dashed #7ee787; outline-offset:2px; }
    #err-overlay{ position:fixed; right:12px; bottom:12px; max-width:520px; background:#1b1b1b; border:1px solid #333; border-radius:.6rem; padding:.75rem 1rem; box-shadow:0 10px 30px rgba(0,0,0,.4); display:none; z-index:9999; }
    #err-overlay h4{ margin:0 0 .25rem 0; font-size:1rem; color:#ffb3b3; }
    #err-overlay pre{ margin:.25rem 0 0 0; white-space:pre-wrap; word-break:break-word; color:#ffdede; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; }
  </style>
</head>
<body>
  <noscript>
    <div class="container">
      <h2>JavaScript ë¹„í™œì„±í™”</h2>
      <p>ì´ í˜ì´ì§€ëŠ” JavaScriptê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í™œì„±í™” í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</p>
    </div>
  </noscript>

  <div id="err-overlay">
    <h4>ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h4>
    <pre id="err-msg"></pre>
  </div>

  <script>
  // ========================= ì „ì—­/ì—ëŸ¬ í•¸ë“¤ë§ =========================
  (function setupErrorOverlay(){
    const box = document.getElementById('err-overlay');
    const pre = document.getElementById('err-msg');
    function show(msg){ try{ pre.textContent = String(msg || 'Unknown error'); box.style.display='block'; }catch(_){} }
    window.addEventListener('error', (e)=>{ console.error('[window.onerror]', e.message, e.filename, e.lineno, e.error); show(e.message + (e.filename? ('\n' + e.filename + ':' + e.lineno) : '')); });
    window.addEventListener('unhandledrejection', (e)=>{ console.error('[unhandledrejection]', e.reason); show((e.reason && (e.reason.message||e.reason)) || 'Unhandled promise rejection'); });
  })();

  const PARTICIPANT = { id:'' };
  function setParticipantId(id){ PARTICIPANT.id = (id||'').trim(); }

  // ========================= ì‹¤í—˜ íŒŒë¼ë¯¸í„° & ìœ í‹¸ =========================
  const IMAGE_DISPLAY_MS = 3000;
  const REST_DISPLAY_MS  = 3000;
  const REPEATS          = 3;

  // â˜… ë³€ê²½: ì‹¤í—˜2 / ì‹¤í—˜3 ê°ê°ì˜ ìê·¹ ëª©ë¡ (íŒŒì¼ëª…ì€ í•„ìš”ì— ë§ê²Œ ìˆ˜ì •í•˜ë©´ ë¨)
  const STIM_EXP2 = [
    'T/1.jpg','T/2.jpg','T/3.jpg','T/4.jpg',
    'T/5.jpg','T/6.jpg','T/7.jpg','T/8.jpg'
  ]; // 8ê°œ

  const STIM_EXP3 = [
    'T/9.jpg','T/10.jpg','T/11.jpg',
    'T/12.jpg','T/13.jpg','T/14.jpg'
  ]; // 6ê°œ

  function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function makeBlocks(list, repeats){ const blocks = []; for(let r=0; r<repeats; r++){ const copy = shuffle(list); blocks.push(copy); } return blocks; }

  const FULLSCREEN_PREFERRED = false;
  async function tryEnterFullscreen(){ if (!FULLSCREEN_PREFERRED) return false; try { const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen(); return true; } catch { return false; } }

  const EXP_ROWS = [];
  const FIRST_STIM = ['T/4.jpg','T/7.jpg'];

  // ========================= ë¶€íŒ… ì „ ìê°€ ì ê²€ (ì´ë¯¸ì§€ ê²½ë¡œ) =========================
  async function selfCheck(){
    const bad = [];
    // â˜… ë³€ê²½: ì‹¤í—˜2/3 ì´ë¯¸ì§€ ëª¨ë‘ ì²´í¬
    const list = Array.from(new Set([...STIM_EXP2, ...STIM_EXP3, ...FIRST_STIM]));
    await Promise.all(list.map(src=> new Promise(res=>{ const im = new Image(); im.onload=()=>res(); im.onerror=()=>{ bad.push(src); res(); }; im.src = src + '?cb=' + Date.now(); })));
    if (bad.length){
      const box = document.getElementById('err-overlay');
      const pre = document.getElementById('err-msg');
      pre.textContent = 'ë‹¤ìŒ ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²½ë¡œ/ëŒ€ì†Œë¬¸ì/ë°°í¬ ë£¨íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n' + bad.join('\n');
      box.style.display='block';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{ try{ runMinimal(); selfCheck(); } catch(e){ console.error(e); const pre=document.getElementById('err-msg'); pre.textContent=String(e && (e.message||e)); document.getElementById('err-overlay').style.display='block'; } });

  function runMinimal(){
    const root = document.body;

    // ----- Page 1: ì‚¬ì „ì„¤ë¬¸ -----
    const page1 = document.createElement('div');
    page1.className = 'container';
    page1.innerHTML = `
      <h1 style="margin-bottom:1rem;">ì‹œì§€ê° ì‹¤í—˜ ì•ˆë‚´</h1>
      <p>ì°¸ì—¬ ì „ì— ê°„ë‹¨í•œ ì‚¬ì „ ì„¤ë¬¸ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”. ì´í›„ <strong>ì‹¤í—˜ 1(ë°°ì¹˜ ê³¼ì œ)</strong>, <strong>ì‹¤í—˜ 2(ìˆ«ì ì‘ë‹µ ê³¼ì œ)</strong>, <strong>ì‹¤í—˜ 3(ìˆ«ì ì‘ë‹µ ê³¼ì œ)</strong>ê°€ ìˆœì„œëŒ€ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>  <!-- â˜… ë¬¸êµ¬ ìˆ˜ì • -->

      <h3 style="margin-top:1.2rem;">ì‚¬ì „ ì„¤ë¬¸</h3>
      <div>
        <label>ì°¸ê°€ì ID:
          <input id="m_id" type="text" required style="width:40%" />
        </label><br>
        <label>ì—°ë ¹:
          <input id="m_age" type="number" min="10" max="100" required style="width:40%" />
        </label><br>
        <label>ì„±ë³„:
          <select id="m_sex" required style="width:40%">
            <option value="female">ì—¬ì„±</option>
            <option value="male">ë‚¨ì„±</option>
            <option value="other">ê¸°íƒ€/ì‘ë‹µ ê±°ë¶€</option>
          </select>
        </label><br>
        </label><br>
        <label>ì£¼ ì‚¬ìš© ì†:
          <select id="m_hand" required style="width:40%">
            <option value="right">ì˜¤ë¥¸ì†</option>
            <option value="left">ì™¼ì†</option>
            <option value="both">ì–‘ì†</option>
          </select>
        </label><br><br>
        <label>ì£¼ì˜ ì‚¬í•­ :
        <ul>
         <li> 13ì¸ì¹˜ ì´ìƒì˜ ëª¨ë‹ˆí„°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</li> 
         <li> ëˆˆë¶€ì‹œì§€ ì•Šê²Œ ëª¨ë‹ˆí„°ì˜ ë°ê¸°ë¥¼ ì¡°ì •í•˜ì„¸ìš”.</li> 
         <li> ì‹¤í—˜ì€ ì•½ 8ë¶„ê°„ ì§„í–‰ë©ë‹ˆë‹¤. ì§‘ì¤‘í•  ìˆ˜ ìˆëŠ” ì¡°ìš©í•œ ê³³ì—ì„œ ì‹¤í—˜ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”.</li> 
         <li> ì ì • ì‹œì•¼ê°ì„ í™•ë³´í•˜ì„¸ìš”.(ëª¨ë‹ˆí„°ê°€ 16ì¸ì¹˜ì¸ ê²½ìš°, ëˆˆê¹Œì§€ì˜ ê±°ë¦¬ ì•½ 50cm) </li> 
         <li> ì‹œì„ ì„ ëª¨ë‹ˆí„°ì— ê³ ì •í•œ ìƒíƒœì—ì„œ í‚¤ë³´ë“œì™€ ë§ˆìš°ìŠ¤ë¡œ ì„¤ë¬¸ì— ì‘ë‹µí•´ì£¼ì„¸ìš”.</li> 
        </ul>
        <p>ìœ„ ë‚´ìš©ì„ ì¤€ìˆ˜í•˜ì…¨ë‚˜ìš”? </p>
          <select id="m_check" required style="width:100%">
            <option value="y">ë„¤</option>
            <option value="n">ì•„ë‹ˆìš”</option>
          </select>
        </label><br><br>
      </div>
      <div style="margin-top:1rem;">
        <button id="m_next" class="btn">ë‹¤ìŒ (ì œì¶œ)</button>
      </div>`;

    document.body.appendChild(page1);

    document.getElementById('m_next').addEventListener('click', async ()=>{
      const pid = document.getElementById('m_id').value.trim();
      const age = document.getElementById('m_age').value.trim();
      if (!pid || !age){ alert('ì°¸ê°€ì IDì™€ ì—°ë ¹ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      setParticipantId(pid);

      const fsOk = await tryEnterFullscreen();
      if (!fsOk) {
        const note = document.createElement('p');
        note.className = 'small hint';
        note.innerHTML = 'â€» ì „ì²´í™”ë©´ ê¶Œí•œì´ ì—†ì–´ ë¹„ì „ì²´í™”ë©´ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.';
        page1.appendChild(note);
      }

      const props = {
        participant_id: pid,
        age,
        sex: document.getElementById('m_sex').value,
        vision: "",
        handedness: document.getElementById('m_hand').value
      };
      page1.remove();
      runFirstExperiment(props);
    });
  }

// ========================= ì²«ë²ˆì§¸ ì‹¤í—˜: ë°°ì¹˜ ê³¼ì œ (ì°½/ë¬¸ ê° ìµœëŒ€ 3ê°œ, íŒŒí‹°ì…˜ ì—†ìŒ) =========================
  function runFirstExperiment(props){
    const root = document.body;

    const intro = document.createElement('div');
    intro.className = 'container';
    intro.innerHTML = `
      <h2>ì‹¤í—˜ 1: ìš”ì†Œ ë°°ì¹˜ ê³¼ì œ</h2>
      <p>ë²½ìœ¼ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ í‰ë©´ì„ ë‘ ì¥ ë³´ì‹œê²Œ ë©ë‹ˆë‹¤. ê° í‰ë©´ì˜ ë‚´ë¶€ë¥¼ ëª‡ ê°œì˜ ê³µê°„ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆëŠ”ì§€ ê°€ëŠ í•˜ê³  <strong>ê° ê³µê°„ ë§ˆë‹¤ ë¬¸ê³¼ ì°½ì„ ì„¤ì¹˜í•˜ì„¸ìš”</strong>. (ìµœëŒ€ 3ê°œê¹Œì§€)</p>
      <div style="margin-top:1rem;"><button id="f1_start" class="btn">ì‹œì‘</button></div>`;
    root.appendChild(intro);

    document.getElementById('f1_start').addEventListener('click', ()=>{ intro.remove(); startSequence(); });

    const order = FIRST_STIM.slice(); // ê³ ì • ìˆœì„œ (10 â†’ 11)
    let idx = 0;

    function startSequence(){ if (idx >= order.length) return finishFirst(props); showPlacementPage(order[idx++]); }

    function showPlacementPage(imgSrc){
      const page = document.createElement('div');
      page.className = 'container';
      page.innerHTML = `
        <h3 style="margin-bottom:.5rem;">ì´ë¯¸ì§€ ë°°ì¹˜</h3>
        <div class="row">
          <div id="place-wrap" class="board">
            <img id="place-img" class="stim-img" src="${imgSrc}?cb=${Date.now()}" />
          </div>
          <div style="flex:1; min-width:220px;">
            <p class="small" style="margin:.25rem 0 .25rem 0;">
              ë²„íŠ¼ì„ í´ë¦­í•œ ë’¤ í•´ë‹¹ ìœ„ì¹˜ë¥¼ ì´ë¯¸ì§€ ìœ„ì—ì„œ í´ë¦­í•˜ì„¸ìš”. ì°½ê³¼ ë¬¸ì„ ì„ íƒ í•œ ë’¤ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              ê° í•­ëª©ì€ <strong>ìµœëŒ€ 3ê°œ</strong>ê¹Œì§€ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div class="toolbar">
              <button class="btn" data-tool="window">ì°½ ë°°ì¹˜(100Ã—10)</button>
              <button class="btn" data-tool="door">ë¬¸ ë°°ì¹˜(Ã˜100)</button>
            </div>
            <div class="toolbar">
              <button class="btn" id="btn-rotate" disabled>ì„ íƒ íšŒì „(90Â°)</button>
              <button class="btn" id="btn-delete" disabled>ì„ íƒ ì‚­ì œ</button>
              <button class="btn" id="reset-cur">í˜„ì¬ ì´ë¯¸ì§€ ì´ˆê¸°í™”</button>
            </div>
            <div class="toolbar">
              <button class="btn" id="next-cur" disabled>ë‹¤ìŒ ì´ë¯¸ì§€</button>
            </div>
            <div class="small" id="cur-status" style="margin-top:.5rem;">í•­ëª©ì„ ì„ íƒí•œ ë’¤, ì´ë¯¸ì§€ ë‚´ ì›í•˜ëŠ” ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.</div>
          </div>
        </div>`;
      root.appendChild(page);

      const wrap = page.querySelector('#place-wrap');
      const btnRotate = page.querySelector('#btn-rotate');
      const btnDelete = page.querySelector('#btn-delete');

      // íŒŒí‹°ì…˜ ì œê±° â†’ window/doorë§Œ ë°°ì—´ë¡œ ê´€ë¦¬(ê° 3ê°œ ì œí•œ)
      const placed = { window: [], door: [] };
      let currentTool = null;
      let selectedEl = null;

      function setStatus(msg){ page.querySelector('#cur-status').textContent = msg; }
      function clearSelect(){ if (selectedEl){ selectedEl.classList.remove('selected'); selectedEl=null; updateToolButtons(); } }
      function selectEl(el){ if (selectedEl===el) return; clearSelect(); selectedEl = el; if (selectedEl){ selectedEl.classList.add('selected'); } updateToolButtons(); }
      function updateToolButtons(){ const tool = selectedEl ? selectedEl.dataset.tool : null; btnRotate.disabled = (tool!=='window'); btnDelete.disabled = !selectedEl; }

      // ë„í˜• ìƒì„± (dataset: tool, angle[0|90])
      function makeRect(tool, w, h){ const el=document.createElement('div'); el.className=`shape ${tool}`; el.style.width=w+'px'; el.style.height=h+'px'; el.dataset.tool=tool; el.dataset.angle='0'; return el; }
      function makeDoor(){ const el=document.createElement('div'); el.className='shape door'; el.style.width='100px'; el.style.height='100px'; el.dataset.tool='door'; return el; }

      function relPos(evt){ const rect=wrap.getBoundingClientRect(); const x=evt.clientX-rect.left; const y=evt.clientY-rect.top; const rx=x/rect.width; const ry=y/rect.height; return {x,y,rx,ry,rect}; }
      function centerPlace(el, cx, cy){ const w=el.offsetWidth, h=el.offsetHeight; el.style.left=Math.round(cx - w/2)+'px'; el.style.top=Math.round(cy - h/2)+'px'; }

      function placeAt(tool, evt){
        if (placed[tool].length >= 3) { setStatus(`${tool}ëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`); return; }
        const p=relPos(evt); let el;
        if (tool==='window') el=makeRect('window',100,10);
        else el=makeDoor();
        wrap.appendChild(el);
        centerPlace(el, p.x, p.y);
        placed[tool].push({ el, rx:p.rx, ry:p.ry, angle: el.dataset.angle||'0', px_w: el.offsetWidth, px_h: el.offsetHeight });
        currentTool=null; setStatus(`${tool} ë°°ì¹˜ ì™„ë£Œ (${placed[tool].length}/3)`); updateNextState();
      }

      function updateRel(it){ const rect=wrap.getBoundingClientRect(); const cx=parseInt(it.el.style.left,10)+it.el.offsetWidth/2; const cy=parseInt(it.el.style.top,10)+it.el.offsetHeight/2; it.rx = cx/rect.width; it.ry = cy/rect.height; it.px_w = it.el.offsetWidth; it.px_h = it.el.offsetHeight; }
      function updateNextState(){ const done = placed.window.length>0 && placed.door.length>0; page.querySelector('#next-cur').disabled = !done; }

      // ë°°ì¹˜ ë²„íŠ¼ë“¤
      page.querySelectorAll('[data-tool]').forEach(btn=>{ btn.addEventListener('click', ()=>{ currentTool = btn.dataset.tool; setStatus(`${btn.textContent} ì„ íƒë¨. ì´ë¯¸ì§€ ë‚´ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.`); }); });
      wrap.addEventListener('click', (evt)=>{ if (currentTool) placeAt(currentTool, evt); });

      // ì„ íƒ/ë“œë˜ê·¸
      wrap.addEventListener('mousedown', (e)=>{
        const target = e.target.closest('.shape'); if (!target) return; selectEl(target);
        let startX=e.clientX, startY=e.clientY; const startLeft=parseInt(target.style.left,10)||0; const startTop=parseInt(target.style.top,10)||0;
        function onMove(ev){ const dx=ev.clientX-startX, dy=ev.clientY-startY; target.style.left = Math.round(startLeft+dx)+"px"; target.style.top = Math.round(startTop+dy)+"px"; }
        function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); const tool=target.dataset.tool; const list=placed[tool]; const item=list.find(i=>i.el===target); if (item) updateRel(item); }
        document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
      });

      // ìš”ì†Œ í´ë¦­ ì‹œ ì„ íƒ í‘œì‹œ (íˆ´ ì„ íƒ ì¤‘ì´ ì•„ë‹ ë•Œ)
      wrap.addEventListener('click', (e)=>{ if (currentTool) return; const el=e.target.closest('.shape'); if (el) selectEl(el); });

      // íšŒì „ 90Â° (ì°½ë§Œ) - width/height êµí™˜ìœ¼ë¡œ ì‹¤ì œ íšŒì „ ë°˜ì˜
      const btnRotateHandler = ()=>{
        if (!selectedEl) return; const tool=selectedEl.dataset.tool; if (tool!=='window') return;
        const prevW=selectedEl.offsetWidth, prevH=selectedEl.offsetHeight;
        const cur = selectedEl.dataset.angle==='90' ? '0' : '90';
        selectedEl.dataset.angle = cur;
        const cx = parseInt(selectedEl.style.left,10)+prevW/2; const cy=parseInt(selectedEl.style.top,10)+prevH/2;
        selectedEl.style.width = prevH+'px';
        selectedEl.style.height = prevW+'px';
        centerPlace(selectedEl, cx, cy);
        const list = placed[tool]; const item=list.find(i=>i.el===selectedEl); if (item){ updateRel(item); item.angle = cur; }
      };
      btnRotate.addEventListener('click', btnRotateHandler);

      // ì‚­ì œ
      btnDelete.addEventListener('click', ()=>{
        if (!selectedEl) return; const tool=selectedEl.dataset.tool; const list=placed[tool]; const i=list.findIndex(it=>it.el===selectedEl);
        if(i>=0){ list[i].el.remove(); list.splice(i,1); }
        clearSelect(); updateNextState(); setStatus('ì„ íƒ í•­ëª©ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
      });

      // ì´ˆê¸°í™”
      page.querySelector('#reset-cur').addEventListener('click', ()=>{
        Object.values(placed).forEach(arr=>arr.forEach(o=>o.el.remove()));
        Object.keys(placed).forEach(k=>placed[k]=[]);
        clearSelect(); updateNextState(); setStatus('í˜„ì¬ ì´ë¯¸ì§€ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });

      // ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì§„í–‰(ì €ì¥)
      page.querySelector('#next-cur').addEventListener('click', ()=>{
        ['window','door'].forEach(kind=>{
          placed[kind].forEach(it=>{
            EXP_ROWS.push({
              participant_id: props.participant_id, age: props.age, sex: props.sex, vision: props.vision, handedness: props.handedness,
              phase: 'placement', image: imgSrc, item: kind, rel_x: it.rx, rel_y: it.ry, angle: it.angle||'0',
              px_left: parseInt(it.el.style.left,10), px_top: parseInt(it.el.style.top,10), px_w: it.el.offsetWidth, px_h: it.el.offsetHeight
            });
          });
        });
        page.remove();
        startSequence();
      });
    }
  }
// ---- ì˜¤ë²„ë ˆì´ PNG ìƒì„±ê¸° (ì‹¤í—˜1 ê²°ê³¼ë¥¼ ì›ë³¸ ìœ„ì— í•©ì„±; ë‹¤ì¤‘ ì°½/ë¬¸ ë°˜ì˜) ----
  function generateOverlayPNGs(rows){
    try{
      window.__FIRST_THUMBS__ = [];
      const uniqueImages = Array.from(new Set(rows.map(r=>r.image)));
      const c = document.createElement('canvas'); c.width=600; c.height=400; const ctx=c.getContext('2d');

      function drawOne(i){
        if (i >= uniqueImages.length) return Promise.resolve();
        const imgSrc = uniqueImages[i];
        const itemRows = rows.filter(r=>r.image===imgSrc);

        const placed = { window: [], door: [] };
        itemRows.forEach(r=>{
          if (r.item === 'window') placed.window.push({ rx:r.rel_x, ry:r.rel_y, angle:r.angle||'0', px_w:r.px_w, px_h:r.px_h });
          else if (r.item === 'door') placed.door.push({ rx:r.rel_x, ry:r.rel_y, px_w:r.px_w, px_h:r.px_h });
        });

        return new Promise(function(loadRes){
          const im = new Image();
          im.onload = function(){
            ctx.clearRect(0,0,c.width,c.height);
            if (im.width && im.height){
              const scale=Math.min(c.width/im.width, c.height/im.height);
              const w=im.width*scale, h=im.height*scale; const ox=(c.width-w)/2, oy=(c.height-h)/2;
              ctx.drawImage(im, ox, oy, w, h);

              function drawRect(it, color){
                const cx=ox + (it.rx*w); const cy=oy + (it.ry*h);
                const rw=(it.px_w||100)*scale; const rh=(it.px_h||10)*scale;
                ctx.save(); ctx.translate(cx, cy); if((it.angle||'0')==='90'){ ctx.rotate(Math.PI/2); }
                ctx.fillStyle=color; ctx.globalAlpha=0.8; ctx.fillRect(-rw/2, -rh/2, rw, rh); ctx.restore();
              }
              function drawDoor(it){
                const cx=ox + (it.rx*w); const cy=oy + (it.ry*h);
                const r=((it.px_w||100)/2)*scale;
                ctx.save(); ctx.globalAlpha=0.5; ctx.strokeStyle='#ff9'; ctx.lineWidth=3;
                ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke(); ctx.restore();
              }

              placed.window.forEach(it=>drawRect(it, '#6cf'));
              placed.door.forEach(it=>drawDoor(it));
            }
            loadRes();
          };
          im.onerror = function(){ loadRes(); };
          im.src = imgSrc + '?cb=' + Date.now();
        }).then(function(){
          return new Promise(function(res){
            c.toBlob(function(blob){
              const href = URL.createObjectURL(blob||new Blob());
              const pid = PARTICIPANT.id || 'anon'; const name = `${pid}_exp1_overlay_${i+1}.png`;
              window.__FIRST_THUMBS__.push({ name, href });
              try { window.dispatchEvent(new CustomEvent('overlay-ready', { detail: { name, href } })); } catch(_){}
              res();
            }, 'image/png');
          });
        }).then(function(){ return drawOne(i+1); });
      }

      drawOne(0);
    }catch(err){ console.error('generateOverlayPNGs error', err); }
  }


  // finishFirst ëë¶€ë¶„ë§Œ ìˆ˜ì •
  function finishFirst(props){
    const rows = EXP_ROWS.filter(r=>r.phase==='placement');
    generateOverlayPNGs(rows); // ë¹„ë™ê¸° ìƒì„±
    runSecondExperiment(props);   // â˜… ê·¸ëŒ€ë¡œ ë‘ê³ , ì‹¤í—˜2 ëì—ì„œ ì‹¤í—˜3ìœ¼ë¡œ ë„˜ì–´ê°€ê²Œ ë§Œë“¦
  }

  // ========================= ë‘ë²ˆì§¸ ì‹¤í—˜: 8ì¥ Ã— 3ì„¸íŠ¸ (24 trial) =========================
  function runSecondExperiment(props){
    const root = document.body;

    const info = document.createElement('div');
    info.className = 'container';
    info.innerHTML = `
      <h2>ì‹¤í—˜ 2 ì•ˆë‚´</h2>
      <p>ì´ë¯¸ì§€ <strong>8ì¥</strong>ì´ ë¬´ì‘ìœ„ ìˆœì„œë¡œ <strong>3ì„¸íŠ¸</strong> ì œì‹œë©ë‹ˆë‹¤ (ì´ 24íšŒ). ì´ë¯¸ì§€ê°€ ì œì‹œë˜ëŠ” ë™ì•ˆ ë²½ìœ¼ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ê³µê°„ì„ ë¶„í• í•˜ê³ , ê·¸ ë¶„í• í•œ ê³µê°„ì˜ ê°œìˆ˜ë¥¼ 1~3 ì¤‘ í•˜ë‚˜ë¥¼ ëˆŒëŸ¬ ì‘ë‹µí•˜ì„¸ìš”.</p>
      <div style="margin-top:1rem;"><button id="exp2_go" class="btn">ì‹œì‘</button></div>`;
    root.appendChild(info);

    document.getElementById('exp2_go').addEventListener('click', ()=>{
      info.remove();

      const preload = STIM_EXP2.map(src => new Promise(res=>{ const im = new Image(); im.onload=()=>res(true); im.onerror=()=>res(false); im.src = src + '?cb=' + Date.now(); }));
      Promise.all(preload).then(results=>{ console.log('Exp2 í”„ë¦¬ë¡œë“œ:', results.filter(Boolean).length, '/', results.length); });

      const screen = document.createElement('div');
      screen.className = 'fullscreen';
      root.appendChild(screen);

      const blocks = makeBlocks(STIM_EXP2, REPEATS);
      const trials = []; blocks.forEach((arr,b)=>arr.forEach((src,i)=>trials.push({src, block:b+1, order:i+1})));

      const fixation = () => { screen.innerHTML = '<div class="fixation">+</div>'; };

      const showImage = (src) => {
        screen.innerHTML = '';
        const wrap = document.createElement('div'); wrap.className = 'container'; wrap.style.textAlign = 'center';
        const img = document.createElement('img'); img.className = 'stim-img'; img.src = src + '?cb=' + Date.now();
        img.onerror = () => { if (/\.jpg($|\?)/i.test(img.src)) { img.onerror=null; img.src = img.src.replace(/\.jpg/i, '.JPG'); } };
        const btnRow = document.createElement('div'); btnRow.style.marginTop = '0.75rem';
        ['1','2','3'].forEach(val =>{ const b = document.createElement('button'); b.className = 'btn'; b.textContent = val; b.dataset.val = val; btnRow.appendChild(b); });
        wrap.appendChild(img); wrap.appendChild(btnRow); screen.appendChild(wrap);
        return {img, btnRow};
      };

      let idx = 0;
      const intro = document.createElement('div'); intro.className = 'container'; intro.style.textAlign = 'center';
      intro.innerHTML = `
        <div class="small" style="margin-bottom:.5rem;">ê³§ ì‹¤í—˜ 2ì˜ ì²« ë²ˆì§¸ ìê·¹ì´ ì œì‹œë©ë‹ˆë‹¤. ì¤€ë¹„í•´ ì£¼ì„¸ìš”.</div>
        <div id="m-count0" style="font-size:48px;">3</div>`;
      root.appendChild(intro);
      (function(){ const el = document.getElementById('m-count0'); let n = 3; const iv = setInterval(()=>{ n--; if (n<=0){ clearInterval(iv); } if (el) el.textContent = String(Math.max(n,0)); }, 1000); setTimeout(()=>{ clearInterval(iv); intro.remove(); next(); }, 3000); })();

      function next(){
        if (idx >= trials.length) return end();
        const t = trials[idx++];
        const {img, btnRow} = showImage(t.src);
        const t0 = performance.now(); let rt = null; let key = '';

        function commit(){
          EXP_ROWS.push({
            participant_id: props.participant_id,
            age: props.age,
            sex: props.sex,
            vision: props.vision,
            handedness: props.handedness,
            phase: 'exp2',              // â˜… phase êµ¬ë¶„
            block: t.block,
            order_in_block: t.order,
            stim_name: t.src,
            response: key,
            rt: rt
          });
          fixation(); setTimeout(next, REST_DISPLAY_MS);
        }
        function onKey(e){ if(['1','2','3'].includes(e.key) && rt===null){ rt = Math.round(performance.now() - t0); key = e.key; cleanup(); commit(); } }
        function onClick(e){ const val = e.target && e.target.dataset ? e.target.dataset.val : null; if (val && rt===null){ rt = Math.round(performance.now() - t0); key = val; cleanup(); commit(); } }
        function cleanup(){ window.removeEventListener('keydown', onKey); btnRow.removeEventListener('click', onClick); }
        window.addEventListener('keydown', onKey, { once:false }); btnRow.addEventListener('click', onClick);
        setTimeout(()=>{ if (rt===null){ cleanup(); commit(); } }, IMAGE_DISPLAY_MS);
      }

      function end(){
        screen.remove();
        runThirdExperiment(props);    // â˜… ì‹¤í—˜3ë¡œ ë°”ë¡œ ì´ë™
      }
    });
  }

  // ========================= ì„¸ë²ˆì§¸ ì‹¤í—˜: 6ì¥ Ã— 3ì„¸íŠ¸ (18 trial) =========================
  function runThirdExperiment(props){
    const root = document.body;

    const info = document.createElement('div');
    info.className = 'container';
    info.innerHTML = `
      <h2>ì‹¤í—˜ 3 ì•ˆë‚´</h2>
      <p>ì´ë²ˆì—ëŠ” ì´ë¯¸ì§€ <strong>6ì¥</strong>ì´ ë¬´ì‘ìœ„ ìˆœì„œë¡œ <strong>3ì„¸íŠ¸</strong> ì œì‹œë©ë‹ˆë‹¤ (ì´ 18íšŒ). ì•ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ì´ë¯¸ì§€ê°€ ì œì‹œë˜ëŠ” ë™ì•ˆ ê³µê°„ ë¶„í•  ê°œìˆ˜ë¥¼ 1~3 ì¤‘ì—ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
      <div style="margin-top:1rem;"><button id="exp3_go" class="btn">ì‹œì‘</button></div>`;
    root.appendChild(info);

    document.getElementById('exp3_go').addEventListener('click', ()=>{
      info.remove();

      const preload = STIM_EXP3.map(src => new Promise(res=>{ const im = new Image(); im.onload=()=>res(true); im.onerror=()=>res(false); im.src = src + '?cb=' + Date.now(); }));
      Promise.all(preload).then(results=>{ console.log('Exp3 í”„ë¦¬ë¡œë“œ:', results.filter(Boolean).length, '/', results.length); });

      const screen = document.createElement('div');
      screen.className = 'fullscreen';
      root.appendChild(screen);

      const blocks = makeBlocks(STIM_EXP3, REPEATS);
      const trials = []; blocks.forEach((arr,b)=>arr.forEach((src,i)=>trials.push({src, block:b+1, order:i+1})));

      const fixation = () => { screen.innerHTML = '<div class="fixation">+</div>'; };

      const showImage = (src) => {
        screen.innerHTML = '';
        const wrap = document.createElement('div'); wrap.className = 'container'; wrap.style.textAlign = 'center';
        const img = document.createElement('img'); img.className = 'stim-img'; img.src = src + '?cb=' + Date.now();
        img.onerror = () => { if (/\.jpg($|\?)/i.test(img.src)) { img.onerror=null; img.src = img.src.replace(/\.jpg/i, '.JPG'); } };
        const btnRow = document.createElement('div'); btnRow.style.marginTop = '0.75rem';
        ['1','2','3'].forEach(val =>{ const b = document.createElement('button'); b.className = 'btn'; b.textContent = val; b.dataset.val = val; btnRow.appendChild(b); });
        wrap.appendChild(img); wrap.appendChild(btnRow); screen.appendChild(wrap);
        return {img, btnRow};
      };

      let idx = 0;
      const intro = document.createElement('div'); intro.className = 'container'; intro.style.textAlign = 'center';
      intro.innerHTML = `
        <div class="small" style="margin-bottom:.5rem;">ê³§ ì‹¤í—˜ 3ì˜ ì²« ë²ˆì§¸ ìê·¹ì´ ì œì‹œë©ë‹ˆë‹¤. ì¤€ë¹„í•´ ì£¼ì„¸ìš”.</div>
        <div id="m-count3" style="font-size:48px;">3</div>`;
      root.appendChild(intro);
      (function(){ const el = document.getElementById('m-count3'); let n = 3; const iv = setInterval(()=>{ n--; if (n<=0){ clearInterval(iv); } if (el) el.textContent = String(Math.max(n,0)); }, 1000); setTimeout(()=>{ clearInterval(iv); intro.remove(); next(); }, 3000); })();

      function next(){
        if (idx >= trials.length) return end();
        const t = trials[idx++];
        const {img, btnRow} = showImage(t.src);
        const t0 = performance.now(); let rt = null; let key = '';

        function commit(){
          EXP_ROWS.push({
            participant_id: props.participant_id,
            age: props.age,
            sex: props.sex,
            vision: props.vision,
            handedness: props.handedness,
            phase: 'exp3',              // â˜… phase êµ¬ë¶„
            block: t.block,
            order_in_block: t.order,
            stim_name: t.src,
            response: key,
            rt: rt
          });
          fixation(); setTimeout(next, REST_DISPLAY_MS);
        }
        function onKey(e){ if(['1','2','3'].includes(e.key) && rt===null){ rt = Math.round(performance.now() - t0); key = e.key; cleanup(); commit(); } }
        function onClick(e){ const val = e.target && e.target.dataset ? e.target.dataset.val : null; if (val && rt===null){ rt = Math.round(performance.now() - t0); key = val; cleanup(); commit(); } }
        function cleanup(){ window.removeEventListener('keydown', onKey); btnRow.removeEventListener('click', onClick); }
        window.addEventListener('keydown', onKey, { once:false }); btnRow.addEventListener('click', onClick);
        setTimeout(()=>{ if (rt===null){ cleanup(); commit(); } }, IMAGE_DISPLAY_MS);
      }

      function end(){
        screen.remove();

        // â˜… ìµœì¢… CSV: ì‹¤í—˜2+ì‹¤í—˜3 ëª¨ë‘ í¬í•¨
        const rows = EXP_ROWS.filter(r => r.phase === 'exp2' || r.phase === 'exp3');

        
        // if (props.comment) rows.forEach(r => r.comment = props.comment);
        const keySet = new Set();
        rows.forEach(r=>Object.keys(r).forEach(k=>keySet.add(k)));

        const preferred = ['participant_id','age','sex','vision','handedness','phase','block','order_in_block','stim_name','image','item','rel_x','rel_y','angle','px_left','px_top','px_w','px_h','response','rt'];
        const headers = preferred.filter(k=>keySet.has(k)).concat([...keySet].filter(k=>!preferred.includes(k)));
        const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>JSON.stringify(r[h] ?? '')).join(','))).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);


        
        const page3 = document.createElement('div'); page3.className = 'container';
        page3.innerHTML = `
          <h2>CSV ë° ì´ë¯¸ì§€ ì „ì†¡ ì•ˆë‚´</h2>
          <p>ë‹¤ìŒ íŒŒì¼ë“¤ì„ ì•„ë˜ ì´ë©”ì¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”:</p>
          <ul>
            <li><a href="${url}" download="vp_experiment.csv"><code>vp_experiment.csv</code></a> (ì‹¤í—˜ 2 &amp; 3 ë°ì´í„°)</li>
          </ul>
          <h3>ì‹¤í—˜ 1 ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ (PNG)</h3>
          <p class="small" id="overlay-hint">ì´ë¯¸ì§€ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ëª©ë¡ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
          <ul id="overlay-list"></ul>
          <p style="font-size:1.1rem;">ğŸ“§ <strong>mform1710@gmail.com</strong></p>
          <p style="margin-top:1rem;">ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>`;
        document.body.appendChild(page3);

        const listEl = page3.querySelector('#overlay-list');
        const hintEl = page3.querySelector('#overlay-hint');
        function addItem(name, href){
          const li = document.createElement('li');
          li.innerHTML = `<a href="${href}" download="${name}">${name}</a>`;
          listEl.appendChild(li);
          if (hintEl) hintEl.style.display = 'none';
        }
        (window.__FIRST_THUMBS__||[]).forEach(t=> addItem(t.name, t.href));
        window.addEventListener('overlay-ready', (e)=>{ const d = e.detail||{}; if (d.name && d.href) addItem(d.name, d.href); });
      }
    });
  }
  </script>

  <!-- selftest ìŠ¤í¬ë¦½íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ë‘ì–´ë„ ë˜ê³  ì‚­ì œí•´ë„ ë¨ -->
  <script>
  (function(){
    try{
      const params = new URLSearchParams(location.search);
      if (params.get('selftest') !== '1') return;
      const out = [];
      function ok(name, cond){ out.push((cond? 'âœ…':'âŒ') + ' ' + name); return !!cond; }
      ok('makeBlocks length=3', makeBlocks([1,2,3], 3).length === 3);
      const el = document.createElement('div'); el.style.position='absolute'; el.style.width='300px'; el.style.height='10px'; document.body.appendChild(el);
      const w1 = el.offsetWidth, h1 = el.offsetHeight; el.style.width=h1+'px'; el.style.height=w1+'px';
      ok('rotate swaps size', el.offsetWidth===h1 && el.offsetHeight===w1);
      const cv=document.createElement('canvas'); cv.width=120; cv.height=80; const ctx=cv.getContext('2d'); const before=cv.toDataURL(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,10,10); const after=cv.toDataURL(); ok('canvas draws', before!==after);
      const box=document.createElement('div'); box.className='container'; box.innerHTML='<h3>Self Test</h3><pre style="background:#0b0b0b; padding:.75rem; border:1px solid #222; border-radius:.5rem;">'+out.join('\n')+'</pre>'; document.body.appendChild(box);
    }catch(e){ console.error('selftest failed', e); }
  })();
  </script>
</body>
</html>
