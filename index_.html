<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>시지각 실험 (온라인)</title>

  <!-- 선택 CSS: 로드 실패 시 자동 무시 -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" crossorigin="anonymous" onerror="this.remove()" />

  <style>
    :root { color-scheme: dark; }
    html,body{ height:100%; }
    body { background:#000; color:#fff; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji; }
    .center-wrap { display:flex; align-items:center; justify-content:center; height:100vh; }
    .fixation { font-size:64px; line-height:1; font-weight:300; }
    .btn { padding:.6rem 1rem; border:1px solid #666; border-radius:.6rem; background:#111; color:#fff; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .btn:hover { background:#1d1d1d; }
    .small { font-size:.9rem; color:#aaa; }
    .container { max-width:1000px; margin:0 auto; padding:2rem; }
    .fullscreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .stim-img { max-width:90vw; max-height:70vh; object-fit:contain; display:block; }
    .hint { color:#9ad0ff; }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.75rem; }
    .row { display:flex; gap:1rem; align-items:flex-start; }
    .board { position:relative; display:inline-block; }
    .shape { position:absolute; box-sizing:border-box; }
    .shape.window { background:#6cf; opacity:.9; }
    .shape.partition { background:#ccc; opacity:.9; }
    .shape.door { border:4px solid #ff9; border-radius:50%; background:rgba(255,255,0,0.1); }
    .shape.selected { outline:2px dashed #7ee787; outline-offset:2px; }
    /* 오류 오버레이 */
    #err-overlay{ position:fixed; right:12px; bottom:12px; max-width:520px; background:#1b1b1b; border:1px solid #333; border-radius:.6rem; padding:.75rem 1rem; box-shadow:0 10px 30px rgba(0,0,0,.4); display:none; z-index:9999; }
    #err-overlay h4{ margin:0 0 .25rem 0; font-size:1rem; color:#ffb3b3; }
    #err-overlay pre{ margin:.25rem 0 0 0; white-space:pre-wrap; word-break:break-word; color:#ffdede; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; }
  </style>
</head>
<body>
  <noscript>
    <div class="container">
      <h2>JavaScript 비활성화</h2>
      <p>이 페이지는 JavaScript가 필요합니다. 브라우저 설정에서 활성화 후 새로고침하세요.</p>
    </div>
  </noscript>

  <!-- 오류 오버레이 (콘솔 외에 화면에도 표시) -->
  <div id="err-overlay">
    <h4>스크립트 오류가 발생했습니다</h4>
    <pre id="err-msg"></pre>
  </div>

  <script>
  // ========================= 전역/에러 핸들링 =========================
  (function setupErrorOverlay(){
    const box = document.getElementById('err-overlay');
    const pre = document.getElementById('err-msg');
    function show(msg){ try{ pre.textContent = String(msg || 'Unknown error'); box.style.display='block'; }catch(_){} }
    window.addEventListener('error', (e)=>{ console.error('[window.onerror]', e.message, e.filename, e.lineno, e.error); show(e.message + (e.filename? ('\n' + e.filename + ':' + e.lineno) : '')); });
    window.addEventListener('unhandledrejection', (e)=>{ console.error('[unhandledrejection]', e.reason); show((e.reason && (e.reason.message||e.reason)) || 'Unhandled promise rejection'); });
  })();

  // 참가자 ID(썸네일 파일명에 포함)
  const PARTICIPANT = { id:'' };
  function setParticipantId(id){ PARTICIPANT.id = (id||'').trim(); }

  // ========================= 실험 파라미터 & 유틸 =========================
  const IMAGE_DISPLAY_MS = 3000;   // 자극 3초
  const REST_DISPLAY_MS  = 3000;   // 고정십자 3초
  const REPEATS          = 3;      // 블록 반복 (9자극 ×3 = 27 시행)

  const STIMULI = [
    'img/10.JPG','img/11.JPG','img/12.JPG','img/13.JPG','img/14.JPG','img/15.JPG','img/16.JPG','img/17.JPG','img/18.JPG'
  ];

  function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function makeBlocks(list, repeats){ const blocks = []; for(let r=0; r<repeats; r++){ const copy = shuffle(list); blocks.push(copy); } return blocks; }

  const FULLSCREEN_PREFERRED = false;
  async function tryEnterFullscreen(){ if (!FULLSCREEN_PREFERRED) return false; try { const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen(); return true; } catch { return false; } }

  // 공용 데이터 버스
  const EXP_ROWS = [];
  const FIRST_STIM = ['img/10.JPG','img/11.JPG'];

  // ========================= 부팅 전 자가 점검 (이미지 경로) =========================
  async function selfCheck(){
    const bad = [];
    const list = Array.from(new Set([...STIMULI, ...FIRST_STIM]));
    await Promise.all(list.map(src=> new Promise(res=>{ const im = new Image(); im.onload=()=>res(); im.onerror=()=>{ bad.push(src); res(); }; im.src = src + '?cb=' + Date.now(); })));
    if (bad.length){
      const box = document.getElementById('err-overlay');
      const pre = document.getElementById('err-msg');
      pre.textContent = '다음 이미지가 로드되지 않습니다. 경로/대소문자/배포 루트를 확인하세요.\n' + bad.join('\n');
      box.style.display='block';
    }
  }

  // ========================= 부팅: 미니멀 모드 시작 =========================
  document.addEventListener('DOMContentLoaded', ()=>{ try{ runMinimal(); selfCheck(); } catch(e){ console.error(e); const pre=document.getElementById('err-msg'); pre.textContent=String(e && (e.message||e)); document.getElementById('err-overlay').style.display='block'; } });

  function runMinimal(){
    const root = document.body;

    // ----- Page 1: 사전설문 -----
    const page1 = document.createElement('div');
    page1.className = 'container';
    page1.innerHTML = `
      <h1 style="margin-bottom:1rem;">시지각 실험 안내</h1>
      <p>참여 전에 간단한 사전 설문을 작성해 주세요. 이후 <strong>실험 1(배치 과제)</strong>과 <strong>실험 2(숫자 응답 과제)</strong>가 순서대로 진행됩니다.</p>
      <h3 style="margin-top:1.2rem;">사전 설문</h3>
      <div>
        <label>참가자 ID(임의 코드):<br>
          <input id="m_id" type="text" required style="width:100%" />
        </label><br><br>
        <label>연령:<br>
          <input id="m_age" type="number" min="10" max="100" required style="width:100%" />
        </label><br><br>
        <label>성별:<br>
          <select id="m_sex" required style="width:100%">
            <option value="male">남성</option>
            <option value="female">여성</option>
            <option value="other">기타/응답 거부</option>
          </select>
        </label><br><br>
        <label>시력 교정 상태:<br>
          <select id="m_vision" required style="width:100%">
            <option value="none">없음</option>
            <option value="glasses">안경</option>
            <option value="contacts">콘택트렌즈</option>
          </select>
        </label><br><br>
        <label>주 사용 손:<br>
          <select id="m_hand" required style="width:100%">
            <option value="right">오른손</option>
            <option value="left">왼손</option>
            <option value="both">양손</option>
          </select>
        </label>
      </div>
      <div style="margin-top:1rem;">
        <button id="m_next" class="btn">다음 (제출)</button>
      </div>`;
    root.appendChild(page1);

    document.getElementById('m_next').addEventListener('click', async ()=>{
      const pid = document.getElementById('m_id').value.trim();
      const age = document.getElementById('m_age').value.trim();
      if (!pid || !age){ alert('참가자 ID와 연령은 필수입니다.'); return; }
      setParticipantId(pid);

      const fsOk = await tryEnterFullscreen();
      if (!fsOk) {
        const note = document.createElement('p');
        note.className = 'small hint';
        note.innerHTML = '※ 전체화면 권한이 없어 비전체화면으로 진행합니다.';
        page1.appendChild(note);
      }

      const props = {
        participant_id: pid,
        age,
        sex: document.getElementById('m_sex').value,
        vision: document.getElementById('m_vision').value,
        handedness: document.getElementById('m_hand').value
      };
      page1.remove();
      runFirstExperiment(props);
    });
  }

  // ========================= 첫번째 실험: 배치 과제 (회전/드래그/삭제) =========================
  function runFirstExperiment(props){
    const root = document.body;

    const intro = document.createElement('div');
    intro.className = 'container';
    intro.innerHTML = `
      <h2>실험 1: 요소 배치 과제</h2>
      <p>2장의 이미지를 각각 한 번씩 보게 됩니다. 각 이미지마다 창, 문, 그리고 필요하면 파티션을 <strong> 1개씩</strong> 배치하세요:</p>
      <div style="margin-top:1rem;"><button id="f1_start" class="btn">시작</button></div>`;
    root.appendChild(intro);

    document.getElementById('f1_start').addEventListener('click', ()=>{ intro.remove(); startSequence(); });

    const order = shuffle(FIRST_STIM);
    let idx = 0;

    function startSequence(){ if (idx >= order.length) return finishFirst(); showPlacementPage(order[idx++]); }

    function showPlacementPage(imgSrc){
      const page = document.createElement('div');
      page.className = 'container';
      page.innerHTML = `
        <h3 style="margin-bottom:.5rem;">이미지 배치</h3>
        <div class="row">
          <div id="place-wrap" class="board">
            <img id="place-img" class="stim-img" src="${imgSrc}?cb=${Date.now()}" />
          </div>
          <div style="flex:1; min-width:220px;">
            <p class="small" style="margin:.25rem 0 .25rem 0;">버튼을 클릭한 뒤 해당 위치를 이미지 위에서 클릭하세요. 창과 문을 선택 한 뒤 드래그하여 위치를 조정할 수 있습니다.</p>
            <div class="toolbar">
              <button class="btn" data-tool="window">창 배치(200×10)</button>
              <button class="btn" data-tool="door">문 배치(Ø100)</button>
              <button class="btn" data-tool="partition">파티션 배치(100×10)</button>
              <span class="small" style="margin-left:.25rem;">(파티션은 설치하지 않아도 됩니다.)</span>
            </div>
            <div class="toolbar">
              <button class="btn" id="btn-rotate" disabled>선택 회전(90°)</button>
              <button class="btn" id="btn-delete" disabled>선택 삭제</button>
              <button class="btn" id="reset-cur">현재 이미지 초기화</button>
            </div>
            <div class="toolbar">
              <button class="btn" id="next-cur" disabled>다음 이미지</button>
            </div>
            <div class="small" id="cur-status" style="margin-top:.5rem;">항목을 선택한 뒤, 이미지 내 원하는 위치를 클릭하세요.</div>
          </div>
        </div>`;
      root.appendChild(page);

      const wrap = page.querySelector('#place-wrap');
      const btnRotate = page.querySelector('#btn-rotate');
      const btnDelete = page.querySelector('#btn-delete');

      const placed = { window: null, partition: null, door: null };
      let currentTool = null;
      let selectedEl = null;

      function setStatus(msg){ page.querySelector('#cur-status').textContent = msg; }
      function clearSelect(){ if (selectedEl){ selectedEl.classList.remove('selected'); selectedEl=null; updateToolButtons(); } }
      function selectEl(el){ if (selectedEl===el) return; clearSelect(); selectedEl = el; if (selectedEl){ selectedEl.classList.add('selected'); } updateToolButtons(); }
      function updateToolButtons(){ const tool = selectedEl ? selectedEl.dataset.tool : null; btnRotate.disabled = !(tool==='window' || tool==='partition'); btnDelete.disabled = !selectedEl; }

      // 도형 생성 (dataset: tool, angle[0|90])
      function makeRect(tool, w, h){ const el=document.createElement('div'); el.className=`shape ${tool}`; el.style.width=w+'px'; el.style.height=h+'px'; el.dataset.tool=tool; el.dataset.angle='0'; return el; }
      function makeDoor(){ const el=document.createElement('div'); el.className='shape door'; el.style.width='100px'; el.style.height='100px'; el.dataset.tool='door'; return el; }

      function relPos(evt){ const rect=wrap.getBoundingClientRect(); const x=evt.clientX-rect.left; const y=evt.clientY-rect.top; const rx=x/rect.width; const ry=y/rect.height; return {x,y,rx,ry,rect}; }
      function centerPlace(el, cx, cy){ const w=el.offsetWidth, h=el.offsetHeight; el.style.left=Math.round(cx - w/2)+'px'; el.style.top=Math.round(cy - h/2)+'px'; }

      function placeAt(tool, evt){
        if (placed[tool]) { setStatus('이미 배치된 항목입니다. 다른 항목을 선택하세요.'); return; }
        const p=relPos(evt); let el;
        if (tool==='window') el=makeRect('window',200,10);
        else if (tool==='partition') el=makeRect('partition',100,10);
        else el=makeDoor();
        wrap.appendChild(el);
        centerPlace(el, p.x, p.y);
        placed[tool] = { el, rx:p.rx, ry:p.ry, angle: el.dataset.angle||'0', px_w: el.offsetWidth, px_h: el.offsetHeight };
        currentTool=null; setStatus(`${tool} 배치 완료`); updateNextState();
      }

      function updateRel(it){ const rect=wrap.getBoundingClientRect(); const cx=parseInt(it.el.style.left,10)+it.el.offsetWidth/2; const cy=parseInt(it.el.style.top,10)+it.el.offsetHeight/2; it.rx = cx/rect.width; it.ry = cy/rect.height; it.px_w = it.el.offsetWidth; it.px_h = it.el.offsetHeight; }
      function updateNextState(){ const done = placed.window && placed.door; page.querySelector('#next-cur').disabled = !done; }

      // 배치 버튼들
      page.querySelectorAll('[data-tool]').forEach(btn=>{ btn.addEventListener('click', ()=>{ currentTool = btn.dataset.tool; setStatus(`${btn.textContent} 선택됨. 이미지 내 위치를 클릭하세요.`); }); });
      wrap.addEventListener('click', (evt)=>{ if (currentTool) placeAt(currentTool, evt); });

      // 선택/드래그
      wrap.addEventListener('mousedown', (e)=>{
        const target = e.target.closest('.shape'); if (!target) return; selectEl(target);
        let startX=e.clientX, startY=e.clientY; const startLeft=parseInt(target.style.left,10)||0; const startTop=parseInt(target.style.top,10)||0;
        function onMove(ev){ const dx=ev.clientX-startX, dy=ev.clientY-startY; target.style.left = Math.round(startLeft+dx)+"px"; target.style.top = Math.round(startTop+dy)+"px"; }
        function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); const tool=target.dataset.tool; if (placed[tool]){ updateRel(placed[tool]); placed[tool].angle = target.dataset.angle||'0'; } }
        document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
      });

      // 요소 클릭 시 선택 표시 (툴 선택 중이 아닐 때)
      wrap.addEventListener('click', (e)=>{ if (currentTool) return; const el=e.target.closest('.shape'); if (el) selectEl(el); });

      // 회전 90° (rect만) - width/height 교환으로 실제 회전 반영
      const btnRotateHandler = ()=>{
        if (!selectedEl) return; const tool=selectedEl.dataset.tool; if (!(tool==='window'||tool==='partition')) return;
        const prevW=selectedEl.offsetWidth, prevH=selectedEl.offsetHeight;
        const cur = selectedEl.dataset.angle==='90' ? '0' : '90';
        selectedEl.dataset.angle = cur;
        const cx = parseInt(selectedEl.style.left,10)+prevW/2; const cy=parseInt(selectedEl.style.top,10)+prevH/2;
        selectedEl.style.width = prevH+'px';
        selectedEl.style.height = prevW+'px';
        centerPlace(selectedEl, cx, cy);
        const it = placed[tool]; if (it){ updateRel(it); it.angle = cur; }
      };
      btnRotate.addEventListener('click', btnRotateHandler);

      // 삭제
      btnDelete.addEventListener('click', ()=>{
        if (!selectedEl) return; const tool=selectedEl.dataset.tool; if (placed[tool]){ placed[tool].el.remove(); placed[tool]=null; } clearSelect(); updateNextState(); setStatus('선택 항목을 삭제했습니다.'); });

      // 초기화
      page.querySelector('#reset-cur').addEventListener('click', ()=>{
        Object.keys(placed).forEach(k=>{ if (placed[k]?.el) placed[k].el.remove(); placed[k]=null; }); clearSelect(); updateNextState(); setStatus('현재 이미지가 초기화되었습니다.');
      });

      // 다음 이미지로 진행(저장)
      page.querySelector('#next-cur').addEventListener('click', ()=>{
        ['window','partition','door'].forEach(kind=>{
          const it = placed[kind];
          if (it){
            EXP_ROWS.push({
              participant_id: props.participant_id, age: props.age, sex: props.sex, vision: props.vision, handedness: props.handedness,
              phase: 'placement', image: imgSrc, item: kind, rel_x: it.rx, rel_y: it.ry, angle: it.angle||'0',
              px_left: parseInt(it.el.style.left,10), px_top: parseInt(it.el.style.top,10), px_w: it.el.offsetWidth, px_h: it.el.offsetHeight
            });
          }
        });
        page.remove();
        startSequence();
      });
    }

    function drawThumbToCanvas(src, placed, canvas){
      const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
      const im=new Image();
      im.onload=()=>{
        const scale=Math.min(canvas.width/im.width, canvas.height/im.height);
        const w=im.width*scale, h=im.height*scale; const ox=(canvas.width-w)/2, oy=(canvas.height-h)/2;
        ctx.drawImage(im, ox, oy, w, h);
        function drawRect(it, color){ if(!it) return; const cx=ox + (it.rx*w); const cy=oy + (it.ry*h); const rw=(it.px_w||100)*scale; const rh=(it.px_h||10)*scale; ctx.save(); ctx.translate(cx, cy); if((it.angle||'0')==='90'){ ctx.rotate(Math.PI/2); } ctx.fillStyle=color; ctx.globalAlpha=0.8; ctx.fillRect(-rw/2, -rh/2, rw, rh); ctx.restore(); }
        function drawDoor(it){ if(!it) return; const cx=ox + (it.rx*w); const cy=oy + (it.ry*h); const r=((it.px_w||100)/2)*scale; ctx.save(); ctx.globalAlpha=0.5; ctx.strokeStyle='#ff9'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke(); ctx.restore(); }
        drawRect(placed.window, '#6cf'); drawRect(placed.partition, '#ccc'); drawDoor(placed.door);
      };
      im.src = src + '?cb=' + Date.now();
    }

    function finishFirst(){
      const sum = document.createElement('div');
      sum.className = 'container';
      const rows = EXP_ROWS.filter(r=>r.phase==='placement');

      sum.innerHTML = `
        <h2>실험 1 요약</h2>
          <button id="go_exp2" class="btn">실험 2로 계속</button>
        </div>`;
      document.body.appendChild(sum);

      // 썸네일 생성 (DOM에 캔버스는 표시하지 않고, 다운로드 링크만 표시)
      const ul = sum.querySelector('#thumb-links');
      window.__FIRST_THUMBS__ = [];
      const uniqueImages = Array.from(new Set(rows.map(r=>r.image)));
      uniqueImages.forEach((imgSrc, i)=>{
        const itemRows = rows.filter(r=>r.image===imgSrc);
        const placed = { window: null, partition: null, door: null };
        itemRows.forEach(r=>{ placed[r.item] = { rx:r.rel_x, ry:r.rel_y, angle:r.angle||'0', px_w:r.px_w, px_h:r.px_h }; });
        const c=document.createElement('canvas'); c.width=240; c.height=160; drawThumbToCanvas(imgSrc, placed, c);
        const href = c.toDataURL('image/png'); const pid = PARTICIPANT.id || 'anon'; const name = `${pid}_exp1_thumb_${i+1}.png`;
        window.__FIRST_THUMBS__.push({ name, href });
        const li = document.createElement('li'); li.innerHTML = `<a class="btn" href="${href}" download="${name}">${name} 저장</a>`; ul.appendChild(li);
      });

      document.getElementById('dl_all_thumbs').addEventListener('click', ()=>{
        (window.__FIRST_THUMBS__||[]).forEach(t=>{ const a=document.createElement('a'); a.href=t.href; a.download=t.name; document.body.appendChild(a); a.click(); a.remove(); });
      });

      document.getElementById('go_exp2').addEventListener('click', ()=>{ sum.remove(); runSecondExperiment(props); });
    }
  }

  // ========================= 두번째 실험: 27 시행(자극 3초 + 휴식 3초) =========================
  function runSecondExperiment(props){
    const root = document.body;

    // ---- 실험 2 안내 페이지 ----
    const info = document.createElement('div');
    info.className = 'container';
    info.innerHTML = `
      <h2>실험 2 안내</h2>
      <p>앞의 실험에서 본 것과 유사한 이미지를 모두 27회 보게 됩니다. 이미지가 제시되는 동안 벽으로 둘러 싸인  공간을 분할하고, 그 개수를 1~3 중 하나를 눌러 응답하세요.</p>
      <div style="margin-top:1rem;"><button id="exp2_go" class="btn">시작</button></div>`;
    root.appendChild(info);

    document.getElementById('exp2_go').addEventListener('click', ()=>{
      info.remove();

      const preload = STIMULI.map(src => new Promise(res=>{ const im = new Image(); im.onload=()=>res(true); im.onerror=()=>res(false); im.src = src + '?cb=' + Date.now(); }));
      Promise.all(preload).then(results=>{ console.log('Exp2 프리로드:', results.filter(Boolean).length, '/', results.length); });

      const screen = document.createElement('div');
      screen.className = 'fullscreen';
      root.appendChild(screen);

      const blocks = makeBlocks(STIMULI, REPEATS);
      const trials = []; blocks.forEach((arr,b)=>arr.forEach((src,i)=>trials.push({src, block:b+1, order:i+1})));

      const fixation = () => { screen.innerHTML = '<div class="fixation">+</div>'; };

      const showImage = (src) => {
        screen.innerHTML = '';
        const wrap = document.createElement('div'); wrap.className = 'container'; wrap.style.textAlign = 'center';
        const img = document.createElement('img'); img.className = 'stim-img'; img.src = src + '?cb=' + Date.now(); img.onerror = () => { if (/\.jpg($|\?)/i.test(img.src)) { img.onerror=null; img.src = img.src.replace(/\.jpg/i, '.JPG'); } };
        const btnRow = document.createElement('div'); btnRow.style.marginTop = '0.75rem'; ['1','2','3'].forEach(val =>{ const b = document.createElement('button'); b.className = 'btn'; b.textContent = val; b.dataset.val = val; btnRow.appendChild(b); });
        wrap.appendChild(img); wrap.appendChild(btnRow); screen.appendChild(wrap);
        return {img, btnRow};
      };

      let idx = 0;
      const intro = document.createElement('div'); intro.className = 'container'; intro.style.textAlign = 'center';
      intro.innerHTML = `
        <div class="small" style="margin-bottom:.5rem;">곧 첫 번째 자극이 제시됩니다. 준비해 주세요.</div>
        <div id="m-count0" style="font-size:48px;">3</div>`; root.appendChild(intro);
      (function(){ const el = document.getElementById('m-count0'); let n = 3; const iv = setInterval(()=>{ n--; if (n<=0){ clearInterval(iv); } if (el) el.textContent = String(Math.max(n,0)); }, 1000); setTimeout(()=>{ clearInterval(iv); intro.remove(); next(); }, 3000); })();

      function next(){
        if (idx >= trials.length) return end();
        const t = trials[idx++];
        const {img, btnRow} = showImage(t.src);
        const t0 = performance.now(); let rt = null; let key = '';

        function commit(){
          EXP_ROWS.push({ participant_id: props.participant_id, age: props.age, sex: props.sex, vision: props.vision, handedness: props.handedness, phase: 'stim', block: t.block, order_in_block: t.order, stim_name: t.src, response: key, rt: rt });
          fixation(); setTimeout(next, REST_DISPLAY_MS);
        }
        function onKey(e){ if(['1','2','3'].includes(e.key) && rt===null){ rt = Math.round(performance.now() - t0); key = e.key; cleanup(); commit(); } }
        function onClick(e){ const val = e.target && e.target.dataset ? e.target.dataset.val : null; if (val && rt===null){ rt = Math.round(performance.now() - t0); key = val; cleanup(); commit(); } }
        function cleanup(){ window.removeEventListener('keydown', onKey); btnRow.removeEventListener('click', onClick); }
        window.addEventListener('keydown', onKey, { once:false }); btnRow.addEventListener('click', onClick);
        setTimeout(()=>{ if (rt===null){ cleanup(); commit(); } }, IMAGE_DISPLAY_MS);
      }

      function end(){
        screen.remove();
        const page2 = document.createElement('div'); page2.className = 'container';
        const headers = Object.keys(EXP_ROWS[0] || {note:'no-data'});
        const csv = [headers.join(',')].concat(EXP_ROWS.map(r=>headers.map(h=>JSON.stringify(r[h] ?? '')).join(','))).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
        page2.innerHTML = `
          <h2>모든 실험이 끝났습니다</h2>
          <p>아래 버튼을 눌러 결과 파일(CSV)을 저장해 주세요.</p>
          <p><a id="m_dl" class="btn" download="vp_experiment.csv">데이터(CSV) 저장</a></p>         
          <div style="margin-top:1rem;"><button id="m_next2" class="btn">전송 안내</button></div>`;
        document.body.appendChild(page2);
        document.getElementById('m_dl').href = url;
        document.getElementById('m_next2').addEventListener('click', ()=>{
          page2.remove(); const page3 = document.createElement('div'); page3.className = 'container';
          const thumbs = (window.__FIRST_THUMBS__||[]).map(t=>`<li><a href="${t.href}" download="${t.name}">${t.name}</a></li>`).join('') || '<li>썸네일이 없습니다.</li>';
          page3.innerHTML = `
            <h2>CSV 및 이미지 전송 안내</h2>
            <p>다음 파일들을 아래 이메일로 보내주세요:</p>
            <ul>
              <li><a href="${url}" download="vp_experiment.csv"><code>vp_experiment.csv</code></a> (실험 1+2 전체 데이터)</li>
              <li>실험 1 썸네일 PNG 2장 (아래 링크에서 다시 다운로드 가능)</li>
            </ul>
            <ul>${thumbs}</ul>
            <p style="font-size:1.1rem;">📧 <strong>mform1710@gmail.com</strong></p>
            <p style="margin-top:1rem;">참여해주셔서 감사합니다.</p>`;
          document.body.appendChild(page3);
        });
      }
    });
  }
  </script>

  <script>
  // ========================= 간단 셀프 테스트 (선택) =========================
  // 주소에 ?selftest=1 을 붙이면 실행되어 기본 동작을 검증합니다.
  (function(){
    try{
      const params = new URLSearchParams(location.search);
      if (params.get('selftest') !== '1') return;
      const out = [];
      function ok(name, cond){ out.push((cond? '✅':'❌') + ' ' + name); return !!cond; }
      // 테스트 1: 블록 생성 길이
      ok('makeBlocks length=3', makeBlocks([1,2,3], 3).length === 3);
      // 테스트 2: 회전 width/height 교환
      const el = document.createElement('div'); el.style.position='absolute'; el.style.width='300px'; el.style.height='10px'; document.body.appendChild(el);
      const w1 = el.offsetWidth, h1 = el.offsetHeight; el.style.width=h1+'px'; el.style.height=w1+'px';
      ok('rotate swaps size', el.offsetWidth===h1 && el.offsetHeight===w1);
      // 테스트 3: 썸네일 캔버스 그리기 (픽셀 변경 여부)
      const cv=document.createElement('canvas'); cv.width=120; cv.height=80; const ctx=cv.getContext('2d'); const before=cv.toDataURL(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,10,10); const after=cv.toDataURL(); ok('canvas draws', before!==after);
      // 출력
      const box=document.createElement('div'); box.className='container'; box.innerHTML='<h3>Self Test</h3><pre style="background:#0b0b0b; padding:.75rem; border:1px solid #222; border-radius:.5rem;">'+out.join('\n')+'</pre>'; document.body.appendChild(box);
    }catch(e){ console.error('selftest failed', e); }
  })();
  </script>
</body>
</html>
