<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹œì§€ê° ì‹¤í—˜ (ì˜¨ë¼ì¸)</title>

  <!-- jsPsych core CSS (í‘œì‹œ ì „ìš©) -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" crossorigin="anonymous" />

  <style>
    :root { color-scheme: dark; }
    body { background:#000; color:#fff; }
    #jspsych-target, .jspsych-content { display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .center-wrap { display:flex; align-items:center; justify-content:center; height:100vh; }
    .fixation { font-size:64px; line-height:1; font-weight:600; }
    .btn { padding:.8rem 1.2rem; border:1px solid #666; border-radius:.6rem; background:#111; color:#fff; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .btn:hover { background:#1d1d1d; }
    .small { font-size:.9rem; color:#aaa; }
    .container { max-width:860px; margin:0 auto; padding:2rem; }
    ol { padding-left:1.2rem; }
    code { background:#111; padding:.1rem .3rem; border-radius:.3rem; }
    .warn { color:#ffca6b; }
    .ok { color:#9aff9a; }
    .err { color:#ff8080; }
    .log { font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem; background:#0b0b0b; border:1px solid #222; padding:.75rem; border-radius:.5rem; white-space:pre-wrap; }
    .row { display:flex; gap:.5rem; flex-wrap:wrap; }
    .fullscreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .stim-img { max-width:90vw; max-height:85vh; object-fit:contain; }
  </style>
  <script>
    // ì „ì—­ ì—ëŸ¬ ë¡œê±°: ì–´ë–¤ ì—ëŸ¬ë“  ë¶€íŒ… íŒ¨ë„ì— ì°íˆë„ë¡
    (function attachGlobalErrorLogger(){
      const queue = [];
      function safeLog(prefix, msg){
        const el = document.getElementById('boot-status');
        const stamp = new Date().toLocaleTimeString();
        const line = `\n[${stamp}] ${prefix}: ${msg}`;
        if (el) { el.innerHTML += line; }
        else { queue.push(line); }
      }
      window.addEventListener('error', function (e){
        const src = e && e.filename ? ` @ ${e.filename}:${e.lineno || ''}` : '';
        const detail = e && e.error && e.error.stack ? ('\n' + e.error.stack) : '';
        safeLog('window.onerror', (e && e.message ? e.message : 'Unknown') + src + detail);
      });
      window.addEventListener('unhandledrejection', function (e){
        const reason = e && e.reason ? (e.reason.stack || e.reason) : 'Unknown promise rejection';
        safeLog('unhandledrejection', String(reason));
      });
      document.addEventListener('DOMContentLoaded', function(){
        if (queue.length){
          const el = document.getElementById('boot-status');
          if (el) el.innerHTML += queue.join('');
        }
      });
    })();
  </script>
</head>
<body>
  <noscript>
    <div class="container">
      <h2 class="warn">JavaScript ë¹„í™œì„±í™”</h2>
      <p>ì´ í˜ì´ì§€ëŠ” JavaScriptê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í™œì„±í™” í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</p>
    </div>
  </noscript>

  <!-- âœ… ë¶€íŒ…/ë””ë²„ê·¸ íŒ¨ë„: ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ê°€ ì „í˜€ ì—†ì–´ë„ í…ìŠ¤íŠ¸ê°€ ë³´ì´ë„ë¡ ìˆœìˆ˜ HTMLë¡œ êµ¬ì„± -->
  <div id="boot" class="container">
    <h1>ì‹œì§€ê° ì‹¤í—˜ â€“ ë¶€íŒ…/ë””ë²„ê·¸ íŒ¨ë„</h1>
    <div id="boot-status" class="log">[0] í˜ì´ì§€ ë¡œë“œ ëŒ€ê¸°â€¦</div>
    <div class="row" style="margin-top:1rem;">
      <button id="btn-load" class="btn" type="button">â‘  jsPsych ë¡œë“œ</button>
      <button id="btn-check" class="btn" type="button" disabled>â‘¡ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ê²€</button>
      <button id="btn-imgcheck" class="btn" type="button">â‘¢ ì´ë¯¸ì§€ ê²½ë¡œ ì ê²€</button>
      <button id="btn-smoke" class="btn" type="button" disabled>â‘£ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸</button>
      <button id="btn-start" class="btn" type="button" disabled>â‘¤ ì‹¤í—˜ ì‹œì‘ (jsPsych)</button>
      <button id="btn-min" class="btn" type="button">ëŒ€ì•ˆ: ë¯¸ë‹ˆë©€ ëª¨ë“œ(ë¬´CDN)</button>
      <button id="btn-env" class="btn" type="button">í™˜ê²½ ì •ë³´</button>
    </div>
    <p class="small" style="margin-top:.75rem;">ê°•ë ¥ ìƒˆë¡œê³ ì¹¨(Ctrl/Cmd+Shift+R) ë˜ëŠ” URLì— <code>?v=2</code>ë¥¼ ë¶™ì—¬ ìºì‹œ ìš°íšŒ ê°€ëŠ¥.</p>
  </div>

  <!-- jsPsychê°€ ë§ˆìš´íŠ¸ë  ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
  <div id="jspsych-target" style="display:none;"></div>

  <script>
  // ========================= Robust dynamic loader =========================
  const CDN = {
    core: [
      // 1) Local vendor ë¨¼ì € ì‹œë„ (CDNì´ ë§‰íŒ í™˜ê²½ ëŒ€ì‘)
      'vendor/jspsych/dist/jspsych.js',
      // 2) Public CDNs
      'https://unpkg.com/jspsych@7.3.3/dist/jspsych.js',
      'https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/jspsych.js'
    ],
    plugins: [
      [
        'vendor/jspsych/plugins/plugin-preload.js',
        'https://unpkg.com/@jspsych/plugin-preload@1.1.3',
        'https://cdn.jsdelivr.net/npm/@jspsych/plugin-preload@1.1.3'
      ],
      [
        'vendor/jspsych/plugins/plugin-fullscreen.js',
        'https://unpkg.com/@jspsych/plugin-fullscreen@1.1.3',
        'https://cdn.jsdelivr.net/npm/@jspsych/plugin-fullscreen@1.1.3'
      ],
      [
        'vendor/jspsych/plugins/plugin-html-keyboard-response.js',
        'https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3',
        'https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-keyboard-response@1.1.3'
      ],
      [
        'vendor/jspsych/plugins/plugin-html-button-response.js',
        'https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3',
        'https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-button-response@1.1.3'
      ],
      [
        'vendor/jspsych/plugins/plugin-image-keyboard-response.js',
        'https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3',
        'https://cdn.jsdelivr.net/npm/@jspsych/plugin-image-keyboard-response@1.1.3'
      ],
      [
        'vendor/jspsych/plugins/plugin-survey-html-form.js',
        'https://unpkg.com/@jspsych/plugin-survey-html-form@1.1.3',
        'https://cdn.jsdelivr.net/npm/@jspsych/plugin-survey-html-form@1.1.3'
      ]
    ]
  };

  function q(id){ return document.getElementById(id); }
  function log(msg, cls){
    const el = q('boot-status');
    const stamp = new Date().toLocaleTimeString();
    el.innerHTML += `\n[${stamp}] ${msg}`;
    if (cls) el.classList.add(cls);
  }

  function loadOne(url){
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      const isCdn = /^https?:\/\//.test(url);
      s.src = url + (isCdn ? (url.includes('?') ? '' : `?cb=${Date.now()}`) : '');
      s.async = false; // preserve order
      if (isCdn) s.crossOrigin = 'anonymous';
      s.onload = ()=> resolve(url);
      s.onerror = ()=> reject(new Error('Load failed: '+url));
      document.head.appendChild(s);
    });
  }

  async function loadWithFallback(urls){
    let lastErr;
    for(const u of urls){
      try { return await loadOne(u); } catch(e){ lastErr = e; log(e.message, 'warn'); }
    }
    throw lastErr;
  }

  async function loadJsPsychAll(){
    log('jsPsych ì½”ì–´ ë¡œë“œ ì¤‘â€¦');
    await loadWithFallback(CDN.core);
    log('ì½”ì–´ OK', 'ok');

    for(const trio of CDN.plugins){
      const label = (trio[0].match(/plugin-([a-z-]+)/) || [,'?'])[1];
      log(`í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì¤‘: ${label}`);
      await loadWithFallback(trio);
    }
    log('í”ŒëŸ¬ê·¸ì¸ OK', 'ok');

    if (typeof window.initJsPsych !== 'function') {
      log('initJsPsych ë¯¸ì •ì˜ â€“ íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”', 'warn');
      log('í•„ìš” íŒŒì¼(ë¡œì»¬ í´ë°± ì‚¬ìš© ì‹œ):', 'warn');
      log(' â€¢ vendor/jspsych/dist/jspsych.js', 'warn');
      log(' â€¢ vendor/jspsych/plugins/plugin-*.js (preload, fullscreen, html-*, image-*, survey-*)', 'warn');
      throw new Error('initJsPsych not found after all fallbacks');
    }
  }

  // ========================= Experiment parameters & utils =========================
  const IMAGE_DISPLAY_MS = 1000;   // ìê·¹ 1ì´ˆ
  const REST_DISPLAY_MS  = 3000;   // ê³ ì •ì‹­ì 3ì´ˆ
  const REPEATS          = 3;      // ë¸”ë¡ ë°˜ë³µ
  const STIMULI = [
    'img/10.jpg','img/11.jpg','img/12.jpg','img/13.jpg','img/14.jpg','img/15.jpg','img/16.jpg','img/17.jpg','img/18.jpg'
  ];

  function makeBlocks(list, repeats){
    const blocks = [];
    for(let r=0; r<repeats; r++){
      const copy = list.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      blocks.push(copy);
    }
    return blocks;
  }

  // ========================= Minimal (no-cdn) runner =========================
  function runMinimal(){
    const root = document.body;
    q('boot').style.display = 'none';

    // Page 1: ì•ˆë‚´ + ì„¤ë¬¸
    const page1 = document.createElement('div');
    page1.className = 'container';
    page1.innerHTML = `
      <h1 style="margin-bottom:1rem;">ì‹œì§€ê° ì‹¤í—˜ ì•ˆë‚´ (ë¯¸ë‹ˆë©€ ëª¨ë“œ)</h1>
      <p>CDN ì°¨ë‹¨ ë“±ìœ¼ë¡œ jsPsychë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´, ìµœì†Œ ê¸°ëŠ¥ìœ¼ë¡œ ì‹¤í—˜ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>
      <p>ì´ <strong>27íšŒ</strong> ì‹œí–‰(ì´ë¯¸ì§€ <strong>1ì´ˆ</strong> ì œì‹œ â†’ ê³ ì •ì‹­ì <strong>3ì´ˆ</strong> íœ´ì‹), ì‘ë‹µí‚¤ <strong>0/1/2/3</strong>.</p>
      <h3 style="margin-top:1.2rem;">ì‚¬ì „ ì„¤ë¬¸</h3>
      <div>
        <label>ì°¸ê°€ì ID(ì„ì˜ ì½”ë“œ):<br>
          <input id="m_id" type="text" required style="width:100%" />
        </label><br><br>
        <label>ì—°ë ¹:<br>
          <input id="m_age" type="number" min="10" max="100" required style="width:100%" />
        </label><br><br>
        <label>ì„±ë³„:<br>
          <select id="m_sex" required style="width:100%">
            <option value="male">ë‚¨ì„±</option>
            <option value="female">ì—¬ì„±</option>
            <option value="other">ê¸°íƒ€/ì‘ë‹µ ê±°ë¶€</option>
          </select>
        </label><br><br>
        <label>ì‹œë ¥ êµì • ìƒíƒœ:<br>
          <select id="m_vision" required style="width:100%">
            <option value="none">ì—†ìŒ</option>
            <option value="glasses">ì•ˆê²½</option>
            <option value="contacts">ì½˜íƒíŠ¸ë Œì¦ˆ</option>
          </select>
        </label><br><br>
        <label>ì£¼ ì‚¬ìš© ì†:<br>
          <select id="m_hand" required style="width:100%">
            <option value="right">ì˜¤ë¥¸ì†</option>
            <option value="left">ì™¼ì†</option>
            <option value="both">ì–‘ì†</option>
          </select>
        </label>
      </div>
      <div style="margin-top:1rem;">
        <button id="m_next" class="btn">ë‹¤ìŒ (ì œì¶œ)</button>
      </div>`;
    root.appendChild(page1);

    function reqFS(){
      const el = document.documentElement;
      if (el.requestFullscreen) return el.requestFullscreen();
      if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
      return Promise.resolve();
    }

    document.getElementById('m_next').addEventListener('click', async ()=>{
      const pid = document.getElementById('m_id').value.trim();
      const age = document.getElementById('m_age').value.trim();
      if (!pid || !age){ alert('ì°¸ê°€ì IDì™€ ì—°ë ¹ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      await reqFS();
      runMinimalTrials({
        participant_id: pid,
        age,
        sex: document.getElementById('m_sex').value,
        vision: document.getElementById('m_vision').value,
        handedness: document.getElementById('m_hand').value
      });
      page1.remove();
    });
  }

  function runMinimalTrials(props){
    const root = document.body;

    // Preload images (non-blocking)
    const preload = STIMULI.map(src => new Promise(res=>{ const im = new Image(); im.onload=()=>res(true); im.onerror=()=>res(false); im.src = src + `?cb=${Date.now()}`; }));
    Promise.all(preload).then(results=>{ log(`ë¯¸ë‹ˆë©€: ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì™„ë£Œ (ì„±ê³µ ${results.filter(Boolean).length}/${results.length})`); });

    const screen = document.createElement('div');
    screen.className = 'fullscreen';
    root.appendChild(screen);

    const blocks = makeBlocks(STIMULI, REPEATS);
    const trials = [];
    blocks.forEach((arr,b)=>arr.forEach((src,i)=>trials.push({src, block:b+1, order:i+1})));

    const rows = [];

    const fixation = () => {
      screen.innerHTML = '<div class="fixation">+</div>';
    };
    const showImage = (src) => {
      screen.innerHTML = '';
      const img = document.createElement('img');
      img.className = 'stim-img';
      img.src = src + `?cb=${Date.now()}`;
      screen.appendChild(img);
      return img;
    };

    let idx = 0;
    const next = () => {
      if (idx >= trials.length) return end();
      const t = trials[idx++];
      const img = showImage(t.src);
      const t0 = performance.now();
      let rt = null; let key = '';
      function onKey(e){
        if(['0','1','2','3'].includes(e.key) && rt===null){
          rt = Math.round(performance.now() - t0);
          key = e.key;
        }
      }
      window.addEventListener('keydown', onKey, { once:false });
      setTimeout(()=>{
        window.removeEventListener('keydown', onKey);
        rows.push({
          participant_id: props.participant_id,
          age: props.age,
          sex: props.sex,
          vision: props.vision,
          handedness: props.handedness,
          phase: 'stim',
          block: t.block,
          order_in_block: t.order,
          stim_name: t.src,
          response: key,
          rt: rt
        });
        fixation();
        setTimeout(next, REST_DISPLAY_MS);
      }, IMAGE_DISPLAY_MS);
    };

    function end(){
      screen.remove();
      const page2 = document.createElement('div');
      page2.className = 'container';
      // build CSV
      const headers = Object.keys(rows[0] || {note:'no-data'});
      const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>JSON.stringify(r[h] ?? '')).join(','))).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      page2.innerHTML = `
        <h2>ì‹¤í—˜ì´ ëë‚¬ìŠµë‹ˆë‹¤ (ë¯¸ë‹ˆë©€ ëª¨ë“œ)</h2>
        <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ íŒŒì¼(CSV)ì„ ì €ì¥í•´ ì£¼ì„¸ìš”.</p>
        <p><a id="m_dl" class="btn" download="vp_experiment.csv">ë°ì´í„°(CSV) ì €ì¥</a></p>
        <div style="margin-top:1rem;"><button id="m_next2" class="btn">ë‹¤ìŒ</button></div>`;
      document.body.appendChild(page2);
      const a = document.getElementById('m_dl'); a.href = url;
      document.getElementById('m_next2').addEventListener('click', ()=>{
        page2.remove();
        const page3 = document.createElement('div');
        page3.className = 'container';
        page3.innerHTML = `
          <h2>CSV íŒŒì¼ ì „ì†¡ ì•ˆë‚´</h2>
          <p>ë°©ê¸ˆ ì €ì¥í•œ <code>vp_experiment.csv</code> íŒŒì¼ì„ ì•„ë˜ ì´ë©”ì¼ ì£¼ì†Œë¡œ ë³´ë‚´ì£¼ì„¸ìš”.</p>
          <p style="font-size:1.1rem;">ğŸ“§ <strong>mform1710@gmail.com</strong></p>
          <div style="margin-top:1rem;"><button class="btn" onclick="window.close();">ì¢…ë£Œ</button></div>`;
        document.body.appendChild(page3);
      });
    }

    fixation();
    setTimeout(next, 500); // brief pause before first trial
  }

  // ========================= Boot UI wiring =========================
  document.addEventListener('DOMContentLoaded', function(){
    const btnLoad  = q('btn-load');
    const btnCheck = q('btn-check');
    const btnImg   = q('btn-imgcheck');
    const btnSmoke = q('btn-smoke');
    const btnStart = q('btn-start');
    const btnMin   = q('btn-min');

    log(`[1] DOM ì¤€ë¹„ë¨ @ ${location.host}`);

    // â‘  jsPsych ë¡œë“œ
    btnLoad.addEventListener('click', async ()=>{
      btnLoad.disabled = true;
      try{
        await loadJsPsychAll();
        log('ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì„±ê³µ', 'ok');
        btnCheck.disabled = false;
        btnSmoke.disabled = false;
        btnStart.disabled = false;
      }catch(e){
        log('ë¡œë”© ì‹¤íŒ¨: '+ e.message, 'err');
        btnLoad.disabled = false;
        // ì¶”ê°€ ê°€ì´ë“œ
        log('í•´ê²° íŒ:', 'warn');
        log(' 1) íšŒì‚¬/ê¸°ê´€ë§ì˜ CDN ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸(unpkg/jsDelivr)', 'warn');
        log(' 2) ê´‘ê³ ì°¨ë‹¨/ê°œì¸ì •ë³´ë³´í˜¸ í™•ì¥í”„ë¡œê·¸ë¨ ì¼ì‹œ ë¹„í™œì„±í™”', 'warn');
        log(' 3) ë¦¬í¬ì— jsPsychë¥¼ ë™ë´‰í•˜ê³  ë¡œì»¬ í´ë°± ê²½ë¡œ(vendor/jspsych/...)ë¥¼ ìƒì„±', 'warn');
        log(' 4) ë‹¹ì¥ì€ ì•„ë˜ "ë¯¸ë‹ˆë©€ ëª¨ë“œ"ë¡œ ì‹¤í—˜ ì§„í–‰ ê°€ëŠ¥', 'warn');
      }
    });

    // â‘¡ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ê²€ (í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: ì „ì—­ ì‹¬ë³¼ í™•ì¸)
    function safeRun(fn){ try { return !!fn(); } catch { return false; } }
    function checkLibs(){
      const tests = [
        ['initJsPsych', ()=> typeof window.initJsPsych === 'function'],
        ['jsPsychHtmlButtonResponse', ()=> typeof window.jsPsychHtmlButtonResponse === 'function'],
        ['jsPsychImageKeyboardResponse', ()=> typeof window.jsPsychImageKeyboardResponse === 'function'],
        ['jsPsychSurveyHtmlForm', ()=> typeof window.jsPsychSurveyHtmlForm === 'function'],
        ['jsPsychFullscreen', ()=> typeof window.jsPsychFullscreen === 'function'],
        ['jsPsychPreload', ()=> typeof window.jsPsychPreload === 'function']
      ];
      let pass = 0;
      log('ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ê²€ ì‹œì‘â€¦');
      tests.forEach(([name, fn])=>{
        const ok = safeRun(fn);
        log(` â€¢ ${name}: ${ok ? 'OK' : 'FAIL'}`, ok ? 'ok' : 'warn');
        if (ok) pass++;
      });
      log(`í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ í•©ê³„: ${pass}/${tests.length} í†µê³¼`);
      return pass === tests.length;
    }
    btnCheck.addEventListener('click', checkLibs);

    // â‘¢ ì´ë¯¸ì§€ ê²½ë¡œ ì ê²€ (í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: 9ê°œ íŒŒì¼ ì„±ê³µ ì—¬ë¶€)
    function checkImages(){
      log('ì´ë¯¸ì§€ ê²½ë¡œ ì ê²€ ì‹œì‘â€¦');
      let remaining = STIMULI.length;
      let failed = 0;
      STIMULI.forEach(src => {
        const img = new Image();
        img.onload = () => { if(--remaining===0) log(`ì´ë¯¸ì§€ ì ê²€ ì™„ë£Œ (ì‹¤íŒ¨ ${failed}ê°œ)`); };
        img.onerror = () => { failed++; log(`âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${src}`, 'warn'); if(--remaining===0) log(`ì´ë¯¸ì§€ ì ê²€ ì™„ë£Œ (ì‹¤íŒ¨ ${failed}ê°œ)`); };
        img.src = src + `?cb=${Date.now()}`; // cache-bust
      });
    }
    btnImg.addEventListener('click', checkImages);

    // í™˜ê²½ ì •ë³´ ì¶œë ¥
    const btnEnv = q('btn-env');
    btnEnv.addEventListener('click', ()=>{
      log('í™˜ê²½ ì •ë³´ ì¶œë ¥ ì‹œì‘â€¦');
      log('UA: ' + navigator.userAgent);
      log('URL: ' + location.href);
      log('Referrer: ' + document.referrer);
      log('Lang: ' + navigator.language);
      log('Online: ' + (navigator.onLine ? 'yes' : 'no'));
    });

    // â‘£ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (ë¯¸ë‹ˆ íƒ€ì„ë¼ì¸) â€” jsPsych í•„ìš”
    btnSmoke.addEventListener('click', ()=>{
      if (!checkLibs()) { alert('ë¨¼ì € jsPsychë¥¼ ë¡œë“œí•˜ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ê²€ì„ í†µê³¼í•˜ì„¸ìš”.'); return; }
      q('boot').style.display = 'none';
      const mount = q('jspsych-target');
      mount.style.display = 'flex';

      const jsPsych = initJsPsych({ display_element: 'jspsych-target' });
      const t = [];
      t.push({ type: jsPsychHtmlButtonResponse, stimulus: '<div class="container"><h2>ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ 1/2</h2><p>ì´ í™”ë©´ì´ ë³´ì´ë©´ jsPsych ì½”ì–´/í”ŒëŸ¬ê·¸ì¸ ë¡œë“œê°€ ì •ìƒì…ë‹ˆë‹¤.</p></div>', choices: ['ê³„ì†'] });
      t.push({ type: jsPsychHtmlButtonResponse, stimulus: '<div class="container"><h2>ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ 2/2</h2><p>ë²„íŠ¼ ì‘ë‹µ í”ŒëŸ¬ê·¸ì¸ ë™ì‘ OK.</p></div>', choices: ['ë'] });
      jsPsych.run(t);
    });

    // â‘¤ ì „ì²´ ì‹¤í—˜ ì‹œì‘ â€” jsPsych í•„ìš”
    btnStart.addEventListener('click', ()=>{
      if (!checkLibs()) { alert('ë¨¼ì € jsPsychë¥¼ ë¡œë“œí•˜ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ê²€ì„ í†µê³¼í•˜ì„¸ìš”.'); return; }
      q('boot').style.display = 'none';
      const mount = q('jspsych-target');
      mount.style.display = 'flex';

      const jsPsych = initJsPsych({ display_element: 'jspsych-target' });
      const timeline = [];

      // (1) ëª©ì /ë°©ë²• ì•ˆë‚´ + ì‚¬ì „ì„¤ë¬¸ (ë²„íŠ¼ ì œì¶œ)
      timeline.push({
        type: jsPsychSurveyHtmlForm,
        preamble: `
          <div class="container">
            <h1 style="margin-bottom:1rem;">ì‹œì§€ê° ì‹¤í—˜ ì•ˆë‚´</h1>
            <p>ë³¸ ì—°êµ¬ëŠ” í™”ë©´ ì¤‘ì•™ì— ì œì‹œë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ê´€ì°°í•  ë•Œì˜ ì£¼ì‹œ í–‰ë™ì„ íŒŒì•…í•˜ê¸° ìœ„í•œ <strong>ì‹œì§€ê° ê³¼ì œ</strong>ì…ë‹ˆë‹¤.</p>
            <p>ì‹¤í—˜ì€ ì´ <strong>27íšŒ</strong> ì‹œí–‰(ì´ë¯¸ì§€ <strong>1ì´ˆ</strong> ì œì‹œ â†’ ê³ ì •ì‹­ì <strong>3ì´ˆ</strong> íœ´ì‹)ìœ¼ë¡œ êµ¬ì„±ë˜ë©°, ì „ì²´ ì†Œìš” ì‹œê°„ì€ ì•½ <strong>3â€“4ë¶„</strong>ì…ë‹ˆë‹¤.</p>
            <h3 style="margin-top:1.2rem;">ì ˆì°¨</h3>
            <ol>
              <li>ì‚¬ì „ ì„¤ë¬¸(ì°¸ê°€ì ID, ì—°ë ¹, ì„±ë³„, ì‹œë ¥ êµì •, ì£¼ ì‚¬ìš© ì†)</li>
              <li>ìê·¹ ê´€ì°° ë° ìˆ«ìí‚¤ <strong>0/1/2/3</strong> ì‘ë‹µ</li>
              <li>CSV ì €ì¥ í›„ ì´ë©”ì¼ ì „ì†¡</li>
            </ol>
            <h3 style="margin-top:1.2rem;">ì—°êµ¬ ì°¸ì—¬ ë™ì˜</h3>
            <ul>
              <li>ìˆ˜ì§‘ ì •ë³´ëŠ” <strong>ìµëª… ID</strong> ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ë˜ë©° ê°œì¸ì„ ì‹ë³„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
              <li>ì–¸ì œë“ ì§€ ì¤‘ë‹¨í•  ìˆ˜ ìˆìœ¼ë©° ë¶ˆì´ìµì€ ì—†ìŠµë‹ˆë‹¤.</li>
              <li>ë°ì´í„°ëŠ” ì—°êµ¬ ëª©ì  ì™¸ì— ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
            </ul>
            <p class="small" style="margin-top:0.8rem;">ë¬¸ì˜: <strong>mform1710@gmail.com</strong></p>
          </div>`,
        html: `
          <div class="container">
            <label>ì°¸ê°€ì ID(ì„ì˜ ì½”ë“œ):<br>
              <input name="participant_id" type="text" required style="width:100%" />
            </label><br><br>
            <label>ì—°ë ¹:<br>
              <input name="age" type="number" min="10" max="100" required style="width:100%" />
            </label><br><br>
            <label>ì„±ë³„:<br>
              <select name="sex" required style="width:100%">
                <option value="male">ë‚¨ì„±</option>
                <option value="female">ì—¬ì„±</option>
                <option value="other">ê¸°íƒ€/ì‘ë‹µ ê±°ë¶€</option>
              </select>
            </label><br><br>
            <label>ì‹œë ¥ êµì • ìƒíƒœ:<br>
              <select name="vision" required style="width:100%">
                <option value="none">ì—†ìŒ</option>
                <option value="glasses">ì•ˆê²½</option>
                <option value="contacts">ì½˜íƒíŠ¸ë Œì¦ˆ</option>
              </select>
            </label><br><br>
            <label>ì£¼ ì‚¬ìš© ì†:<br>
              <select name="handedness" required style="width:100%">
                <option value="right">ì˜¤ë¥¸ì†</option>
                <option value="left">ì™¼ì†</option>
                <option value="both">ì–‘ì†</option>
              </select>
            </label>
          </div>
        `,
        button_label: 'ë‹¤ìŒ (ì œì¶œ)',
        on_finish: (data)=>{
          try{
            const resp = JSON.parse(data.responses);
            jsPsych.data.addProperties({
              participant_id: resp.participant_id || '',
              age: resp.age || '',
              sex: resp.sex || '',
              vision: resp.vision || '',
              handedness: resp.handedness || ''
            });
          }catch(e){ /* ignore */ }
        }
      });

      // ì „ì²´í™”ë©´ ì „í™˜ (ë²„íŠ¼)
      timeline.push({
        type: jsPsychFullscreen,
        message: `<div class="container">
          <h2>ì „ì²´ í™”ë©´ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤</h2>
          <p>ìê·¹ì´ ì œì‹œë˜ëŠ” ë™ì•ˆ ìˆ«ìí‚¤ <strong>0/1/2/3</strong> ì¤‘ í•˜ë‚˜ë¥¼ ëˆŒëŸ¬ ì‘ë‹µí•´ ì£¼ì„¸ìš”.</p>
        </div>`,
        fullscreen_mode: true,
        button_label: 'ì‹œì‘'
      });

      // ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ (ì—ëŸ¬ ë¬´ì‹œ, ì§„í–‰)
      timeline.push({
        type: jsPsychPreload,
        images: STIMULI,
        continue_after_error: true,
        message: '<div class="container"><p>ìê·¹ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p></div>',
        error_message: '<div class="container"><p>ì¼ë¶€ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.</p></div>',
        on_error: function(file){ console.error('Preload ì‹¤íŒ¨:', file); }
      });

      // ê³ ì •ì‹­ì(íœ´ì‹)
      const fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div class="center-wrap"><div class="fixation">+</div></div>',
        choices: 'NO_KEYS',
        trial_duration: REST_DISPLAY_MS,
        data: { phase: 'rest' }
      };

      // ìê·¹(ì‘ë‹µ: 0/1/2/3)
      const showStim = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        render_on_canvas: false,
        choices: ['0','1','2','3'],
        trial_duration: IMAGE_DISPLAY_MS,
        maintain_aspect_ratio: true,
        data: {
          phase: 'stim',
          block: jsPsych.timelineVariable('block'),
          order_in_block: jsPsych.timelineVariable('order_in_block'),
          stim_name: jsPsych.timelineVariable('stimulus')
        }
      };

      // ë¸”ë¡ ë‹¨ìœ„ ì…”í”Œ â†’ ì´ 27 ì‹œí–‰
      const blocks = makeBlocks(STIMULI, REPEATS);
      const timeline_variables = [];
      blocks.forEach((bArr, bIdx)=>{
        bArr.forEach((src, i)=>{
          timeline_variables.push({ stimulus: src, block: bIdx+1, order_in_block: i+1 });
        });
      });

      timeline.push({ timeline: [showStim, fixation], timeline_variables });

      // CSV ì €ì¥ í˜ì´ì§€
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class=\"container\">\n          <h2>ì‹¤í—˜ì´ ëë‚¬ìŠµë‹ˆë‹¤</h2>\n          <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ íŒŒì¼(CSV)ì„ ì €ì¥í•´ ì£¼ì„¸ìš”.</p>\n          <p><a id=\"download-link\" class=\"btn\" download=\"vp_experiment.csv\">ë°ì´í„°(CSV) ì €ì¥</a></p>\n          <p class=\"small\">CSVì—ëŠ” ì°¸ê°€ì ì •ë³´(ID/ì—°ë ¹/ì„±ë³„/ì‹œë ¥/ì†ì¡ì´), ì‹œí–‰ ì •ë³´(block/order), ì‘ë‹µ(0/1/2/3), ë°˜ì‘ì‹œê°„ ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤.</p>\n        </div>`,
        choices: ['ë‹¤ìŒ'],
        on_load: () => {
          const csv = jsPsych.data.get().csv();
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.getElementById('download-link');
          if (a) a.href = url;
        }
      });

      // ì „ì†¡ ì•ˆë‚´/ë¬¸ì˜ì²˜ (ì¢…ë£Œ)
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class=\"container\">\n          <h2>CSV íŒŒì¼ ì „ì†¡ ì•ˆë‚´</h2>\n          <p>ë°©ê¸ˆ ì €ì¥í•œ <code>vp_experiment.csv</code> íŒŒì¼ì„ ì•„ë˜ ì´ë©”ì¼ ì£¼ì†Œë¡œ ë³´ë‚´ì£¼ì„¸ìš”.</p>\n          <p style=\"font-size:1.1rem;\">ğŸ“§ <strong>mform1710@gmail.com</strong></p>\n          <p class=\"small\">ë¬¸ì˜ê°€ ìˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš° ìœ„ ì£¼ì†Œë¡œ ì—°ë½í•´ ì£¼ì„¸ìš”.</p>\n        </div>`,
        choices: ['ì¢…ë£Œ']
      });

      jsPsych.run(timeline);
    });

    // ëŒ€ì•ˆ: ë¯¸ë‹ˆë©€ ëª¨ë“œ (CDN ë¶ˆê°€ í™˜ê²½ìš©)
    btnMin.addEventListener('click', runMinimal);
  });
  </script>
</body>
</html>
