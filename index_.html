<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹œì§€ê° ì‹¤í—˜ (ì˜¨ë¼ì¸)</title>

  <!-- ì„ íƒ CSS: ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìë™ ë¬´ì‹œ -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" crossorigin="anonymous" onerror="this.remove()" />

  <style>
    :root { color-scheme: dark; }
    html,body{ height:100%; }
    body { background:#000; color:#fff; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji; }
    .center-wrap { display:flex; align-items:center; justify-content:center; height:100vh; }
    .fixation { font-size:64px; line-height:1; font-weight:300; }
    .btn { padding:.6rem 1rem; border:1px solid #666; border-radius:.6rem; background:#111; color:#fff; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .btn:hover { background:#1d1d1d; }
    .small { font-size:.9rem; color:#aaa; }
    .container { max-width:1000px; margin:0 auto; padding:2rem; }
    .fullscreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .stim-img { max-width:90vw; max-height:70vh; object-fit:contain; display:block; }
    .hint { color:#9ad0ff; }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.75rem; }
    .row { display:flex; gap:1rem; align-items:flex-start; }
    .board { position:relative; display:inline-block; }
    .shape { position:absolute; box-sizing:border-box; }
    .shape.window { background:#6cf; opacity:.9; }
    .shape.door { border:4px solid #ff9; border-radius:50%; background:rgba(255,255,0,0.1); }
    .shape.selected { outline:2px dashed #7ee787; outline-offset:2px; }
    #err-overlay{ position:fixed; right:12px; bottom:12px; max-width:520px; background:#1b1b1b; border:1px solid #333; border-radius:.6rem; padding:.75rem 1rem; box-shadow:0 10px 30px rgba(0,0,0,.4); display:none; z-index:9999; }
    #err-overlay h4{ margin:0 0 .25rem 0; font-size:1rem; color:#ffb3b3; }
    #err-overlay pre{ margin:.25rem 0 0 0; white-space:pre-wrap; word-break:break-word; color:#ffdede; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; }
  </style>
</head>
<body>
  <noscript>
    <div class="container">
      <h2>JavaScript ë¹„í™œì„±í™”</h2>
      <p>ì´ í˜ì´ì§€ëŠ” JavaScriptê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í™œì„±í™” í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</p>
    </div>
  </noscript>

  <div id="err-overlay">
    <h4>ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h4>
    <pre id="err-msg"></pre>
  </div>

  <script>
  // ========================= ì „ì—­/ì—ëŸ¬ í•¸ë“¤ë§ =========================
  (function setupErrorOverlay(){
    const box = document.getElementById('err-overlay');
    const pre = document.getElementById('err-msg');
    function show(msg){ try{ pre.textContent = String(msg || 'Unknown error'); box.style.display='block'; }catch(_){} }
    window.addEventListener('error', (e)=>{ console.error('[window.onerror]', e.message, e.filename, e.lineno, e.error); show(e.message + (e.filename? ('\n' + e.filename + ':' + e.lineno) : '')); });
    window.addEventListener('unhandledrejection', (e)=>{ console.error('[unhandledrejection]', e.reason); show((e.reason && (e.reason.message||e.reason)) || 'Unhandled promise rejection'); });
  })();

  const PARTICIPANT = { id:'' };
  function setParticipantId(id){ PARTICIPANT.id = (id||'').trim(); }

  // ========================= ì‹¤í—˜ íŒŒë¼ë¯¸í„° & ìœ í‹¸ =========================
  const IMAGE_DISPLAY_MS = 3000;
  const REST_DISPLAY_MS  = 3000;
  const REPEATS          = 3;

  // â˜… ë³€ê²½: ì‹¤í—˜2 / ì‹¤í—˜3 ê°ê°ì˜ ìê·¹ ëª©ë¡ (íŒŒì¼ëª…ì€ í•„ìš”ì— ë§ê²Œ ìˆ˜ì •í•˜ë©´ ë¨)
  const STIM_EXP2 = [
    'TIMG/1.JPG','TIMG/2.JPG','TIMG/3.JPG','TIMG/4.JPG',
    'TIMG/5.JPG','TIMG/6.JPG','TIMG/7.JPG','TIMG/8.JPG'
  ]; // 8ê°œ

  const STIM_EXP3 = [
    'TIMG/9.JPG','TIMG/10.JPG','TIMG/11.JPG',
    'TIMG/12.JPG','TIMG/13.JPG','TIMG/14.JPG'
  ]; // 6ê°œ

  function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function makeBlocks(list, repeats){ const blocks = []; for(let r=0; r<repeats; r++){ const copy = shuffle(list); blocks.push(copy); } return blocks; }

  const FULLSCREEN_PREFERRED = false;
  async function tryEnterFullscreen(){ if (!FULLSCREEN_PREFERRED) return false; try { const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen(); return true; } catch { return false; } }

  const EXP_ROWS = [];
  const FIRST_STIM = ['TIMG/4.JPG','TIMG/7.JPG'];

  // ========================= ë¶€íŒ… ì „ ìê°€ ì ê²€ (ì´ë¯¸ì§€ ê²½ë¡œ) =========================
  async function selfCheck(){
    const bad = [];
    // â˜… ë³€ê²½: ì‹¤í—˜2/3 ì´ë¯¸ì§€ ëª¨ë‘ ì²´í¬
    const list = Array.from(new Set([...STIM_EXP2, ...STIM_EXP3, ...FIRST_STIM]));
    await Promise.all(list.map(src=> new Promise(res=>{ const im = new Image(); im.onload=()=>res(); im.onerror=()=>{ bad.push(src); res(); }; im.src = src + '?cb=' + Date.now(); })));
    if (bad.length){
      const box = document.getElementById('err-overlay');
      const pre = document.getElementById('err-msg');
      pre.textContent = 'ë‹¤ìŒ ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²½ë¡œ/ëŒ€ì†Œë¬¸ì/ë°°í¬ ë£¨íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n' + bad.join('\n');
      box.style.display='block';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{ try{ runMinimal(); selfCheck(); } catch(e){ console.error(e); const pre=document.getElementById('err-msg'); pre.textContent=String(e && (e.message||e)); document.getElementById('err-overlay').style.display='block'; } });

  function runMinimal(){
    const root = document.body;

    // ----- Page 1: ì‚¬ì „ì„¤ë¬¸ -----
    const page1 = document.createElement('div');
    page1.className = 'container';
    page1.innerHTML = `
      <h1 style="margin-bottom:1rem;">ì‹œì§€ê° ì‹¤í—˜ ì•ˆë‚´</h1>
      <p>ì°¸ì—¬ ì „ì— ê°„ë‹¨í•œ ì‚¬ì „ ì„¤ë¬¸ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”. ì´í›„ <strong>ì‹¤í—˜ 1(ë°°ì¹˜ ê³¼ì œ)</strong>, <strong>ì‹¤í—˜ 2(ìˆ«ì ì‘ë‹µ ê³¼ì œ)</strong>, <strong>ì‹¤í—˜ 3(ìˆ«ì ì‘ë‹µ ê³¼ì œ)</strong>ê°€ ìˆœì„œëŒ€ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>  <!-- â˜… ë¬¸êµ¬ ìˆ˜ì • -->

      <h3 style="margin-top:1.2rem;">ì‚¬ì „ ì„¤ë¬¸</h3>
      <div>
        <label>ì°¸ê°€ì ID:
          <input id="m_id" type="text" required style="width:40%" />
        </label><br>
        <label>ì—°ë ¹:
          <input id="m_age" type="number" min="10" max="100" required style="width:40%" />
        </label><br>
        <label>ì„±ë³„:
          <select id="m_sex" required style="width:40%">
            <option value="female">ì—¬ì„±</option>
            <option value="male">ë‚¨ì„±</option>
            <option value="other">ê¸°íƒ€/ì‘ë‹µ ê±°ë¶€</option>
          </select>
        </label><br>
        </label><br>
        <label>ì£¼ ì‚¬ìš© ì†:
          <select id="m_hand" required style="width:40%">
            <option value="right">ì˜¤ë¥¸ì†</option>
            <option value="left">ì™¼ì†</option>
            <option value="both">ì–‘ì†</option>
          </select>
        </label><br><br>
        <label>ì£¼ì˜ ì‚¬í•­ :
        <ul>
         <li> 13ì¸ì¹˜ ì´ìƒì˜ ëª¨ë‹ˆí„°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</li> 
         <li> ëˆˆë¶€ì‹œì§€ ì•Šê²Œ ëª¨ë‹ˆí„°ì˜ ë°ê¸°ë¥¼ ì¡°ì •í•˜ì„¸ìš”.</li> 
         <li> ì‹¤í—˜ì€ ì•½ 8ë¶„ê°„ ì§„í–‰ë©ë‹ˆë‹¤. ì§‘ì¤‘í•  ìˆ˜ ìˆëŠ” ì¡°ìš©í•œ ê³³ì—ì„œ ì‹¤í—˜ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”.</li> 
         <li> ì ì • ì‹œì•¼ê°ì„ í™•ë³´í•˜ì„¸ìš”.(ëª¨ë‹ˆí„°ê°€ 16ì¸ì¹˜ì¸ ê²½ìš°, ëˆˆê¹Œì§€ì˜ ê±°ë¦¬ ì•½ 50cm) </li> 
         <li> ì‹œì„ ì„ ëª¨ë‹ˆí„°ì— ê³ ì •í•œ ìƒíƒœì—ì„œ í‚¤ë³´ë“œì™€ ë§ˆìš°ìŠ¤ë¡œ ì„¤ë¬¸ì— ì‘ë‹µí•´ì£¼ì„¸ìš”.</li> 
        </ul>
        <p>ìœ„ ë‚´ìš©ì„ ì¤€ìˆ˜í•˜ì…¨ë‚˜ìš”? </p>
          <select id="m_check" required style="width:100%">
            <option value="y">ë„¤</option>
            <option value="n">ì•„ë‹ˆìš”</option>
          </select>
        </label><br><br>
      </div>
      <div style="margin-top:1rem;">
        <button id="m_next" class="btn">ë‹¤ìŒ (ì œì¶œ)</button>
      </div>`;

    document.body.appendChild(page1);

    document.getElementById('m_next').addEventListener('click', async ()=>{
      const pid = document.getElementById('m_id').value.trim();
      const age = document.getElementById('m_age').value.trim();
      if (!pid || !age){ alert('ì°¸ê°€ì IDì™€ ì—°ë ¹ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      setParticipantId(pid);

      const fsOk = await tryEnterFullscreen();
      if (!fsOk) {
        const note = document.createElement('p');
        note.className = 'small hint';
        note.innerHTML = 'â€» ì „ì²´í™”ë©´ ê¶Œí•œì´ ì—†ì–´ ë¹„ì „ì²´í™”ë©´ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.';
        page1.appendChild(note);
      }

      const props = {
        participant_id: pid,
        age,
        sex: document.getElementById('m_sex').value,
        vision: "",
        handedness: document.getElementById('m_hand').value
      };
      page1.remove();
      runFirstExperiment(props);
    });
  }

  // ========================= (ì‹¤í—˜1 ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ) =========================
  // ... (ì—¬ê¸°ê¹Œì§€ëŠ” ë„¤ê°€ ì¤€ ì½”ë“œ ê·¸ëŒ€ë¡œ ë‘ë©´ ë¨)
  // runFirstExperiment, generateOverlayPNGs ë“±ì€ ìˆ˜ì • ì—†ì´ ì‚¬ìš©

  // finishFirst ëë¶€ë¶„ë§Œ ìˆ˜ì •
  function finishFirst(props){
    const rows = EXP_ROWS.filter(r=>r.phase==='placement');
    generateOverlayPNGs(rows); // ë¹„ë™ê¸° ìƒì„±
    runSecondExperiment(props);   // â˜… ê·¸ëŒ€ë¡œ ë‘ê³ , ì‹¤í—˜2 ëì—ì„œ ì‹¤í—˜3ìœ¼ë¡œ ë„˜ì–´ê°€ê²Œ ë§Œë“¦
  }

  // ========================= ë‘ë²ˆì§¸ ì‹¤í—˜: 8ì¥ Ã— 3ì„¸íŠ¸ (24 trial) =========================
  function runSecondExperiment(props){
    const root = document.body;

    const info = document.createElement('div');
    info.className = 'container';
    info.innerHTML = `
      <h2>ì‹¤í—˜ 2 ì•ˆë‚´</h2>
      <p>ì´ë¯¸ì§€ <strong>8ì¥</strong>ì´ ë¬´ì‘ìœ„ ìˆœì„œë¡œ <strong>3ì„¸íŠ¸</strong> ì œì‹œë©ë‹ˆë‹¤ (ì´ 24íšŒ). ì´ë¯¸ì§€ê°€ ì œì‹œë˜ëŠ” ë™ì•ˆ ë²½ìœ¼ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ê³µê°„ì„ ë¶„í• í•˜ê³ , ê·¸ ê°œìˆ˜ë¥¼ 1~3 ì¤‘ í•˜ë‚˜ë¥¼ ëˆŒëŸ¬ ì‘ë‹µí•˜ì„¸ìš”.</p>
      <div style="margin-top:1rem;"><button id="exp2_go" class="btn">ì‹œì‘</button></div>`;
    root.appendChild(info);

    document.getElementById('exp2_go').addEventListener('click', ()=>{
      info.remove();

      const preload = STIM_EXP2.map(src => new Promise(res=>{ const im = new Image(); im.onload=()=>res(true); im.onerror=()=>res(false); im.src = src + '?cb=' + Date.now(); }));
      Promise.all(preload).then(results=>{ console.log('Exp2 í”„ë¦¬ë¡œë“œ:', results.filter(Boolean).length, '/', results.length); });

      const screen = document.createElement('div');
      screen.className = 'fullscreen';
      root.appendChild(screen);

      const blocks = makeBlocks(STIM_EXP2, REPEATS);
      const trials = []; blocks.forEach((arr,b)=>arr.forEach((src,i)=>trials.push({src, block:b+1, order:i+1})));

      const fixation = () => { screen.innerHTML = '<div class="fixation">+</div>'; };

      const showImage = (src) => {
        screen.innerHTML = '';
        const wrap = document.createElement('div'); wrap.className = 'container'; wrap.style.textAlign = 'center';
        const img = document.createElement('img'); img.className = 'stim-img'; img.src = src + '?cb=' + Date.now();
        img.onerror = () => { if (/\.jpg($|\?)/i.test(img.src)) { img.onerror=null; img.src = img.src.replace(/\.jpg/i, '.JPG'); } };
        const btnRow = document.createElement('div'); btnRow.style.marginTop = '0.75rem';
        ['1','2','3'].forEach(val =>{ const b = document.createElement('button'); b.className = 'btn'; b.textContent = val; b.dataset.val = val; btnRow.appendChild(b); });
        wrap.appendChild(img); wrap.appendChild(btnRow); screen.appendChild(wrap);
        return {img, btnRow};
      };

      let idx = 0;
      const intro = document.createElement('div'); intro.className = 'container'; intro.style.textAlign = 'center';
      intro.innerHTML = `
        <div class="small" style="margin-bottom:.5rem;">ê³§ ì‹¤í—˜ 2ì˜ ì²« ë²ˆì§¸ ìê·¹ì´ ì œì‹œë©ë‹ˆë‹¤. ì¤€ë¹„í•´ ì£¼ì„¸ìš”.</div>
        <div id="m-count0" style="font-size:48px;">3</div>`;
      root.appendChild(intro);
      (function(){ const el = document.getElementById('m-count0'); let n = 3; const iv = setInterval(()=>{ n--; if (n<=0){ clearInterval(iv); } if (el) el.textContent = String(Math.max(n,0)); }, 1000); setTimeout(()=>{ clearInterval(iv); intro.remove(); next(); }, 3000); })();

      function next(){
        if (idx >= trials.length) return end();
        const t = trials[idx++];
        const {img, btnRow} = showImage(t.src);
        const t0 = performance.now(); let rt = null; let key = '';

        function commit(){
          EXP_ROWS.push({
            participant_id: props.participant_id,
            age: props.age,
            sex: props.sex,
            vision: props.vision,
            handedness: props.handedness,
            phase: 'exp2',              // â˜… phase êµ¬ë¶„
            block: t.block,
            order_in_block: t.order,
            stim_name: t.src,
            response: key,
            rt: rt
          });
          fixation(); setTimeout(next, REST_DISPLAY_MS);
        }
        function onKey(e){ if(['1','2','3'].includes(e.key) && rt===null){ rt = Math.round(performance.now() - t0); key = e.key; cleanup(); commit(); } }
        function onClick(e){ const val = e.target && e.target.dataset ? e.target.dataset.val : null; if (val && rt===null){ rt = Math.round(performance.now() - t0); key = val; cleanup(); commit(); } }
        function cleanup(){ window.removeEventListener('keydown', onKey); btnRow.removeEventListener('click', onClick); }
        window.addEventListener('keydown', onKey, { once:false }); btnRow.addEventListener('click', onClick);
        setTimeout(()=>{ if (rt===null){ cleanup(); commit(); } }, IMAGE_DISPLAY_MS);
      }

      function end(){
        screen.remove();
        runThirdExperiment(props);    // â˜… ì‹¤í—˜3ë¡œ ë°”ë¡œ ì´ë™
      }
    });
  }

  // ========================= ì„¸ë²ˆì§¸ ì‹¤í—˜: 6ì¥ Ã— 3ì„¸íŠ¸ (18 trial) =========================
  function runThirdExperiment(props){
    const root = document.body;

    const info = document.createElement('div');
    info.className = 'container';
    info.innerHTML = `
      <h2>ì‹¤í—˜ 3 ì•ˆë‚´</h2>
      <p>ì´ë²ˆì—ëŠ” ì´ë¯¸ì§€ <strong>6ì¥</strong>ì´ ë¬´ì‘ìœ„ ìˆœì„œë¡œ <strong>3ì„¸íŠ¸</strong> ì œì‹œë©ë‹ˆë‹¤ (ì´ 18íšŒ). ì•ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ì´ë¯¸ì§€ê°€ ì œì‹œë˜ëŠ” ë™ì•ˆ ê³µê°„ ë¶„í•  ê°œìˆ˜ë¥¼ 1~3 ì¤‘ì—ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
      <div style="margin-top:1rem;"><button id="exp3_go" class="btn">ì‹œì‘</button></div>`;
    root.appendChild(info);

    document.getElementById('exp3_go').addEventListener('click', ()=>{
      info.remove();

      const preload = STIM_EXP3.map(src => new Promise(res=>{ const im = new Image(); im.onload=()=>res(true); im.onerror=()=>res(false); im.src = src + '?cb=' + Date.now(); }));
      Promise.all(preload).then(results=>{ console.log('Exp3 í”„ë¦¬ë¡œë“œ:', results.filter(Boolean).length, '/', results.length); });

      const screen = document.createElement('div');
      screen.className = 'fullscreen';
      root.appendChild(screen);

      const blocks = makeBlocks(STIM_EXP3, REPEATS);
      const trials = []; blocks.forEach((arr,b)=>arr.forEach((src,i)=>trials.push({src, block:b+1, order:i+1})));

      const fixation = () => { screen.innerHTML = '<div class="fixation">+</div>'; };

      const showImage = (src) => {
        screen.innerHTML = '';
        const wrap = document.createElement('div'); wrap.className = 'container'; wrap.style.textAlign = 'center';
        const img = document.createElement('img'); img.className = 'stim-img'; img.src = src + '?cb=' + Date.now();
        img.onerror = () => { if (/\.jpg($|\?)/i.test(img.src)) { img.onerror=null; img.src = img.src.replace(/\.jpg/i, '.JPG'); } };
        const btnRow = document.createElement('div'); btnRow.style.marginTop = '0.75rem';
        ['1','2','3'].forEach(val =>{ const b = document.createElement('button'); b.className = 'btn'; b.textContent = val; b.dataset.val = val; btnRow.appendChild(b); });
        wrap.appendChild(img); wrap.appendChild(btnRow); screen.appendChild(wrap);
        return {img, btnRow};
      };

      let idx = 0;
      const intro = document.createElement('div'); intro.className = 'container'; intro.style.textAlign = 'center';
      intro.innerHTML = `
        <div class="small" style="margin-bottom:.5rem;">ê³§ ì‹¤í—˜ 3ì˜ ì²« ë²ˆì§¸ ìê·¹ì´ ì œì‹œë©ë‹ˆë‹¤. ì¤€ë¹„í•´ ì£¼ì„¸ìš”.</div>
        <div id="m-count3" style="font-size:48px;">3</div>`;
      root.appendChild(intro);
      (function(){ const el = document.getElementById('m-count3'); let n = 3; const iv = setInterval(()=>{ n--; if (n<=0){ clearInterval(iv); } if (el) el.textContent = String(Math.max(n,0)); }, 1000); setTimeout(()=>{ clearInterval(iv); intro.remove(); next(); }, 3000); })();

      function next(){
        if (idx >= trials.length) return end();
        const t = trials[idx++];
        const {img, btnRow} = showImage(t.src);
        const t0 = performance.now(); let rt = null; let key = '';

        function commit(){
          EXP_ROWS.push({
            participant_id: props.participant_id,
            age: props.age,
            sex: props.sex,
            vision: props.vision,
            handedness: props.handedness,
            phase: 'exp3',              // â˜… phase êµ¬ë¶„
            block: t.block,
            order_in_block: t.order,
            stim_name: t.src,
            response: key,
            rt: rt
          });
          fixation(); setTimeout(next, REST_DISPLAY_MS);
        }
        function onKey(e){ if(['1','2','3'].includes(e.key) && rt===null){ rt = Math.round(performance.now() - t0); key = e.key; cleanup(); commit(); } }
        function onClick(e){ const val = e.target && e.target.dataset ? e.target.dataset.val : null; if (val && rt===null){ rt = Math.round(performance.now() - t0); key = val; cleanup(); commit(); } }
        function cleanup(){ window.removeEventListener('keydown', onKey); btnRow.removeEventListener('click', onClick); }
        window.addEventListener('keydown', onKey, { once:false }); btnRow.addEventListener('click', onClick);
        setTimeout(()=>{ if (rt===null){ cleanup(); commit(); } }, IMAGE_DISPLAY_MS);
      }

      function end(){
        screen.remove();

        // â˜… ìµœì¢… CSV: ì‹¤í—˜2+ì‹¤í—˜3 ëª¨ë‘ í¬í•¨
        const rows = EXP_ROWS.filter(r => r.phase === 'exp2' || r.phase === 'exp3');
        const keySet = new Set();
        rows.forEach(r=>Object.keys(r).forEach(k=>keySet.add(k)));

        const preferred = ['participant_id','age','sex','vision','handedness','phase','block','order_in_block','stim_name','image','item','rel_x','rel_y','angle','px_left','px_top','px_w','px_h','response','rt'];
        const headers = preferred.filter(k=>keySet.has(k)).concat([...keySet].filter(k=>!preferred.includes(k)));
        const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>JSON.stringify(r[h] ?? '')).join(','))).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const page3 = document.createElement('div'); page3.className = 'container';
        page3.innerHTML = `
          <h2>CSV ë° ì´ë¯¸ì§€ ì „ì†¡ ì•ˆë‚´</h2>
          <p>ë‹¤ìŒ íŒŒì¼ë“¤ì„ ì•„ë˜ ì´ë©”ì¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”:</p>
          <ul>
            <li><a href="${url}" download="vp_experiment.csv"><code>vp_experiment.csv</code></a> (ì‹¤í—˜ 2 &amp; 3 ë°ì´í„°)</li>
          </ul>
          <h3>ì‹¤í—˜ 1 ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ (PNG)</h3>
          <p class="small" id="overlay-hint">ì´ë¯¸ì§€ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ëª©ë¡ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
          <ul id="overlay-list"></ul>
          <p style="font-size:1.1rem;">ğŸ“§ <strong>mform1710@gmail.com</strong></p>
          <p style="margin-top:1rem;">ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>`;
        document.body.appendChild(page3);

        const listEl = page3.querySelector('#overlay-list');
        const hintEl = page3.querySelector('#overlay-hint');
        function addItem(name, href){
          const li = document.createElement('li');
          li.innerHTML = `<a href="${href}" download="${name}">${name}</a>`;
          listEl.appendChild(li);
          if (hintEl) hintEl.style.display = 'none';
        }
        (window.__FIRST_THUMBS__||[]).forEach(t=> addItem(t.name, t.href));
        window.addEventListener('overlay-ready', (e)=>{ const d = e.detail||{}; if (d.name && d.href) addItem(d.name, d.href); });
      }
    });
  }
  </script>

  <!-- selftest ìŠ¤í¬ë¦½íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ë‘ì–´ë„ ë˜ê³  ì‚­ì œí•´ë„ ë¨ -->
  <script>
  (function(){
    try{
      const params = new URLSearchParams(location.search);
      if (params.get('selftest') !== '1') return;
      const out = [];
      function ok(name, cond){ out.push((cond? 'âœ…':'âŒ') + ' ' + name); return !!cond; }
      ok('makeBlocks length=3', makeBlocks([1,2,3], 3).length === 3);
      const el = document.createElement('div'); el.style.position='absolute'; el.style.width='300px'; el.style.height='10px'; document.body.appendChild(el);
      const w1 = el.offsetWidth, h1 = el.offsetHeight; el.style.width=h1+'px'; el.style.height=w1+'px';
      ok('rotate swaps size', el.offsetWidth===h1 && el.offsetHeight===w1);
      const cv=document.createElement('canvas'); cv.width=120; cv.height=80; const ctx=cv.getContext('2d'); const before=cv.toDataURL(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,10,10); const after=cv.toDataURL(); ok('canvas draws', before!==after);
      const box=document.createElement('div'); box.className='container'; box.innerHTML='<h3>Self Test</h3><pre style="background:#0b0b0b; padding:.75rem; border:1px solid #222; border-radius:.5rem;">'+out.join('\n')+'</pre>'; document.body.appendChild(box);
    }catch(e){ console.error('selftest failed', e); }
  })();
  </script>
</body>
</html>
